<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸¥æ ¼æ•°å­¦éªŒè¯ç³»ç»Ÿ - AI-Pythonåä½œç‰ˆ v2.1</title>
    
    <!-- MathJaxé…ç½® -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            startup: {
                pageReady: () => {
                    return MathJax.startup.defaultPageReady().then(() => {
                        console.log('MathJaxæ¸²æŸ“å®Œæˆ');
                    });
                }
            }
        };
    </script>
    
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            min-height: 100vh;
            color: #333;
            padding: 10px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #e74c3c 100%);
            color: white;
            padding: 25px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.2rem;
            margin-bottom: 8px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 1fr 450px;
            gap: 0;
        }

        .main-content {
            padding: 25px;
        }

        .control-panel {
            background: #f8f9fa;
            border-left: 1px solid #dee2e6;
            padding: 25px;
            max-height: 90vh;
            overflow-y: auto;
        }

        /* ä¸¥æ ¼éªŒè¯æµç¨‹å›¾ */
        .verification-pipeline {
            background: #fff;
            border: 2px solid #e74c3c;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .pipeline-title {
            text-align: center;
            color: #e74c3c;
            font-weight: bold;
            font-size: 1.2rem;
            margin-bottom: 20px;
        }

        .verification-steps {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .verification-step {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s;
        }

        .verification-step.active {
            border-color: #007bff;
            background: #e3f2fd;
            transform: scale(1.05);
        }

        .verification-step.completed {
            border-color: #28a745;
            background: #d4edda;
        }

        .verification-step.failed {
            border-color: #dc3545;
            background: #f8d7da;
        }

        .step-number {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: #6c757d;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin: 0 auto 10px;
        }

        .step-number.active { background: #007bff; }
        .step-number.completed { background: #28a745; }
        .step-number.failed { background: #dc3545; }

        .step-label {
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .step-desc {
            font-size: 0.75rem;
            color: #6c757d;
            line-height: 1.3;
        }

        /* PythonéªŒè¯èŠ‚ç‚¹ */
        .python-nodes {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .python-node {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 8px;
            font-size: 0.7rem;
            text-align: center;
            transition: all 0.3s;
        }

        .python-node.active {
            background: #d1ecf1;
            border-color: #bee5eb;
        }

        .python-node.completed {
            background: #d4edda;
            border-color: #c3e6cb;
        }

        .python-node.failed {
            background: #f8d7da;
            border-color: #f5c6cb;
        }

        /* è¾“å…¥åŒºåŸŸ */
        .input-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .input-group textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            resize: vertical;
            min-height: 140px;
            font-family: inherit;
            line-height: 1.6;
        }

        .solve-btn {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .solve-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }

        .solve-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        /* éªŒè¯çŠ¶æ€é¢æ¿ */
        .verification-status {
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .status-item {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 12px;
            text-align: center;
        }

        .status-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #007bff;
        }

        .status-label {
            font-size: 0.8rem;
            color: #6c757d;
            margin-top: 5px;
        }

        /* é”™è¯¯æŠ¥å‘Šç³»ç»Ÿ */
        .error-report {
            background: #fff5f5;
            border: 1px solid #fed7d7;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
        }

        .error-report.critical {
            border-color: #fc8181;
            background: #fef5f5;
        }

        .error-report.warning {
            border-color: #fbb6ce;
            background: #fffaf0;
        }

        .error-header {
            display: flex;
            align-items: center;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .error-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8rem;
        }

        .error-icon.critical { background: #e53e3e; }
        .error-icon.warning { background: #dd6b20; }

        .error-details {
            font-size: 0.9rem;
            line-height: 1.6;
        }

        /* ç»“æœå±•ç¤ºåŒºåŸŸ */
        .result-section {
            background: #fff;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #007bff;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .result-section.completed {
            border-left-color: #28a745;
        }

        .result-section.failed {
            border-left-color: #dc3545;
        }

        .result-section.python {
            border-left-color: #ffc107;
        }

        .result-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #dee2e6;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .result-content {
            padding: 20px;
            line-height: 1.8;
        }

        .math-content {
            font-size: 1.05rem;
        }

        .math-content .MathJax {
            font-size: 1.1em !important;
        }

        /* Pythonä»£ç å±•ç¤º */
        .python-code {
            background: #2d3748;
            color: #e2e8f0;
            border-radius: 8px;
            margin: 15px 0;
            overflow: hidden;
        }

        .python-header {
            background: #4a5568;
            color: white;
            padding: 12px 20px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .python-content {
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.4;
            white-space: pre-wrap;
            overflow-x: auto;
        }

        .python-output {
            background: #1a202c;
            color: #e2e8f0;
            border-radius: 8px;
            margin-top: 10px;
            overflow: hidden;
        }

        .output-header {
            background: #2d3748;
            color: white;
            padding: 10px 20px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .output-content {
            padding: 15px 20px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            line-height: 1.4;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }

        .output-success {
            border-left: 4px solid #48bb78;
        }

        .output-error {
            border-left: 4px solid #f56565;
        }

        /* è¿­ä»£è¿½è¸ª */
        .iteration-tracker {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .iteration-info {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .iteration-item {
            background: rgba(255,255,255,0.1);
            border-radius: 6px;
            padding: 10px;
        }

        .iteration-value {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .iteration-label {
            font-size: 0.8rem;
            opacity: 0.9;
            margin-top: 5px;
        }

        /* åŠ è½½çŠ¶æ€ */
        .loading {
            text-align: center;
            padding: 30px;
            display: none;
        }

        .loading.show { display: block; }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #e74c3c;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        .loading-text {
            font-size: 1.1rem;
            color: #495057;
            font-weight: 500;
        }

        /* é…ç½®é¢æ¿ */
        .config-section {
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 18px;
            margin-bottom: 20px;
        }

        .config-title {
            font-weight: bold;
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .config-group {
            margin-bottom: 15px;
        }

        .config-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
            font-size: 0.9rem;
            color: #495057;
        }

        .config-group input, .config-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .config-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }

        .config-btn:hover {
            background: #138496;
            transform: translateY(-1px);
        }

        .save-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            margin-left: 10px;
        }

        .save-btn:hover {
            background: #218838;
        }

        /* æ–‡ä»¶ä¿å­˜åŒºåŸŸ */
        .save-section {
            background: #e8f5e8;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            padding: 18px;
            margin-bottom: 20px;
        }

        .save-section .config-btn {
            background: #28a745;
            margin-bottom: 8px;
        }

        .save-section .config-btn:hover {
            background: #218838;
        }

        .saved-files-info {
            background: rgba(255,255,255,0.7);
            border-radius: 6px;
            padding: 12px;
            margin-top: 10px;
            font-size: 0.85rem;
        }

        /* éªŒè¯æ‘˜è¦æ ·å¼ */
        .verification-summary {
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .verification-summary h3 {
            margin-bottom: 15px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .summary-item strong {
            display: block;
            margin-bottom: 5px;
        }

        /* æ“ä½œæŒ‰é’®æ ·å¼ */
        .action-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        /* LaTeXé¢„è§ˆæ ·å¼ */
        .latex-preview {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            font-family: 'Computer Modern', serif;
            line-height: 1.6;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1400px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
            
            .control-panel {
                border-left: none;
                border-top: 1px solid #dee2e6;
            }

            .verification-steps {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .verification-steps {
                grid-template-columns: 1fr;
            }

            .python-nodes {
                grid-template-columns: 1fr;
            }

            .status-grid {
                grid-template-columns: 1fr;
            }

            .iteration-info {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* åŠ¨ç”»æ•ˆæœ */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        .result-section {
            animation: slideIn 0.3s ease;
        }

        /* æ•°å­¦å…¬å¼é«˜äº® */
        .formula-highlight {
            background: linear-gradient(135deg, #f8f9ff 0%, #e7f3ff 100%);
            border: 1px solid #b3d9ff;
            border-radius: 6px;
            padding: 12px;
            margin: 12px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        mjx-container {
            display: inline-block !important;
            margin: 0.2em 0 !important;
        }

        mjx-container[display="true"] {
            display: block !important;
            text-align: center !important;
            margin: 1em 0 !important;
        }

        /* çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-left: 8px;
        }

        .status-connected { background: #28a745; }
        .status-disconnected { background: #dc3545; }
        .status-testing { 
            background: #ffc107; 
            animation: pulse 1s infinite; 
        }

        /* é€šçŸ¥æ ·å¼ */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 12px 20px;
            border-radius: 6px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            animation: slideInRight 0.3s ease;
        }

        .notification.error {
            background: #dc3545;
        }

        .notification.warning {
            background: #ffc107;
            color: #212529;
        }

        /* æ‰¹é‡ä¿å­˜å¯¹è¯æ¡† */
        .batch-save-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            z-index: 1001;
            min-width: 400px;
            text-align: center;
        }

        .batch-save-dialog h3 {
            color: #495057;
            margin-bottom: 20px;
        }

        .batch-save-progress {
            background: #f8f9fa;
            border-radius: 10px;
            height: 20px;
            margin: 15px 0;
            overflow: hidden;
        }

        .batch-save-progress-bar {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            height: 100%;
            transition: width 0.3s ease;
            width: 0%;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”¬ ä¸¥æ ¼æ•°å­¦éªŒè¯ç³»ç»Ÿ</h1>
            <p>åŸºäºè®ºæ–‡é€»è¾‘çš„AI-Pythonåä½œéªŒè¯æ¡†æ¶ v2.1 (å¢å¼ºç‰ˆ)</p>
        </div>

        <div class="main-layout">
            <div class="main-content">
                <!-- è¾“å…¥åŒºåŸŸ -->
                <div class="input-section">
                    <div class="input-group">
                        <label for="problem-input">ğŸ“ æ•°å­¦é—®é¢˜æè¿°:</label>
                        <textarea id="problem-input" placeholder="è¯·è¾“å…¥éœ€è¦ä¸¥æ ¼éªŒè¯çš„æ•°å­¦é—®é¢˜...">è¯æ˜ï¼šå¯¹äºå‡½æ•° f(x) = xÂ³ - 3xÂ² + 2x - 1ï¼Œåœ¨åŒºé—´ [0, 2] ä¸Šå­˜åœ¨å”¯ä¸€é›¶ç‚¹ã€‚

è¦æ±‚å®Œæ•´è¯æ˜ï¼š
1. è¯æ˜é›¶ç‚¹å­˜åœ¨æ€§
2. è¯æ˜é›¶ç‚¹å”¯ä¸€æ€§  
3. ç»™å‡ºé›¶ç‚¹çš„ç²¾ç¡®ä½ç½®
4. åˆ†æå‡½æ•°çš„å•è°ƒæ€§å’Œæå€¼</textarea>
                    </div>
                    
                    <button class="solve-btn" onclick="startRigorousVerification()" id="solve-button">
                        ğŸš€ å¯åŠ¨ä¸¥æ ¼éªŒè¯æµç¨‹
                    </button>
                </div>

                <!-- ä¸¥æ ¼éªŒè¯æµç¨‹å›¾ -->
                <div class="verification-pipeline">
                    <div class="pipeline-title">ğŸ”„ ä¸¥æ ¼æ•°å­¦éªŒè¯æµç¨‹ (åŸºäºè®ºæ–‡é€»è¾‘)</div>
                    
                    <div class="verification-steps">
                        <div class="verification-step" id="main-step-1">
                            <div class="step-number" id="main-step-1-num">1</div>
                            <div class="step-label">åˆå§‹è§£ç”Ÿæˆ</div>
                            <div class="step-desc">ç”Ÿæˆè¯¦ç»†çš„æ•°å­¦è§£ç­”</div>
                        </div>
                        
                        <div class="verification-step" id="main-step-2">
                            <div class="step-number" id="main-step-2-num">2</div>
                            <div class="step-label">è‡ªæˆ‘æ”¹è¿›</div>
                            <div class="step-desc">åŸºäºéªŒè¯ç»“æœæ”¹è¿›</div>
                        </div>
                        
                        <div class="verification-step" id="main-step-3">
                            <div class="step-number" id="main-step-3-num">3</div>
                            <div class="step-label">ä¸¥æ ¼éªŒè¯</div>
                            <div class="step-desc">ç”Ÿæˆè¯¦ç»†é”™è¯¯æŠ¥å‘Š</div>
                        </div>
                        
                        <div class="verification-step" id="main-step-4">
                            <div class="step-number" id="main-step-4-num">4</div>
                            <div class="step-label">é”™è¯¯æŠ¥å‘Šå®¡æŸ¥</div>
                            <div class="step-desc">å®¡æŸ¥å’Œåˆ†ç±»é—®é¢˜</div>
                        </div>
                        
                        <div class="verification-step" id="main-step-5">
                            <div class="step-number" id="main-step-5-num">5</div>
                            <div class="step-label">ä¿®æ­£ä¸ä¼˜åŒ–</div>
                            <div class="step-desc">åŸºäºæŠ¥å‘Šæ”¹è¿›è§£ç­”</div>
                        </div>
                        
                        <div class="verification-step" id="main-step-6">
                            <div class="step-number" id="main-step-6-num">6</div>
                            <div class="step-label">æœ€ç»ˆå†³ç­–</div>
                            <div class="step-desc">æ¥å—æˆ–ç»§ç»­è¿­ä»£</div>
                        </div>
                    </div>

                    <!-- PythonéªŒè¯èŠ‚ç‚¹ -->
                    <div class="python-nodes">
                        <div class="python-node" id="python-node-1">ğŸ åˆå§‹å¿«é€ŸéªŒè¯</div>
                        <div class="python-node" id="python-node-2">ğŸ” æ•°å­¦æ¨ç†é¢„éªŒè¯</div>
                        <div class="python-node" id="python-node-3">âš¡ ä»£ç æ‰§è¡ŒéªŒè¯</div>
                        <div class="python-node" id="python-node-4">ğŸ¯ ä¸“é¡¹æ•°å­¦éªŒè¯</div>
                        <div class="python-node" id="python-node-5">ğŸ“Š å¢é‡å¯¹æ¯”éªŒè¯</div>
                        <div class="python-node" id="python-node-6">ğŸ”§ é”™è¯¯æ£€æµ‹ä¿®å¤</div>
                        <div class="python-node" id="python-node-7">âœ… äº¤å‰éªŒè¯ç¡®è®¤</div>
                    </div>
                </div>

                <!-- è¿­ä»£çŠ¶æ€è¿½è¸ª -->
                <div class="iteration-tracker" id="iteration-tracker" style="display: none;">
                    <h4>ğŸ”„ å½“å‰éªŒè¯çŠ¶æ€</h4>
                    <div class="iteration-info">
                        <div class="iteration-item">
                            <div class="iteration-value" id="current-iteration">0</div>
                            <div class="iteration-label">å½“å‰è¿­ä»£</div>
                        </div>
                        <div class="iteration-item">
                            <div class="iteration-value" id="consecutive-passes">0</div>
                            <div class="iteration-label">è¿ç»­é€šè¿‡</div>
                        </div>
                        <div class="iteration-item">
                            <div class="iteration-value" id="total-errors">0</div>
                            <div class="iteration-label">å‘ç°é”™è¯¯</div>
                        </div>
                        <div class="iteration-item">
                            <div class="iteration-value" id="python-validations">0</div>
                            <div class="iteration-label">PythonéªŒè¯</div>
                        </div>
                    </div>
                </div>

                <!-- åŠ è½½çŠ¶æ€ -->
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <div class="loading-text" id="loading-text">ğŸ¤– æ­£åœ¨å¯åŠ¨ä¸¥æ ¼éªŒè¯ç³»ç»Ÿ...</div>
                </div>

                <!-- ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
                <div id="results-container">
                    <!-- åŠ¨æ€ç”Ÿæˆçš„éªŒè¯ç»“æœ -->
                </div>
            </div>

            <div class="control-panel">
                <!-- AIé…ç½® -->
                <div class="config-section">
                    <div class="config-title">ğŸ¤– AIé…ç½®</div>
                    
                    <div class="config-group">
                        <label>APIæä¾›å•†:</label>
                        <select id="api-provider">
                            <option value="deepseek">DeepSeek V3 (æ¨è)</option>
                            <option value="gemini">Google Gemini 2.5 Pro</option>
                            <option value="openai">OpenAI GPT-4</option>
                        </select>
                    </div>
                    
                    <div class="config-group">
                        <label>APIå¯†é’¥:</label>
                        <input type="password" id="api-key" placeholder="sk-... æˆ– AIza...">
                    </div>
                    
                    <div class="config-group">
                        <label>æ¨¡å‹ç‰ˆæœ¬:</label>
                        <select id="model-version">
                            <option value="deepseek-chat">DeepSeek Chat</option>
                        </select>
                    </div>
                    
                    <button class="config-btn" onclick="testAIConnection()" id="test-btn">
                        ğŸ”— æµ‹è¯•è¿æ¥ 
                        <span class="status-indicator status-disconnected" id="connection-status"></span>
                    </button>
                </div>

                <!-- éªŒè¯é…ç½® -->
                <div class="config-section">
                    <div class="config-title">âš™ï¸ éªŒè¯é…ç½®</div>
                    
                    <div class="config-group">
                        <label>æœ€å¤§è¿­ä»£æ¬¡æ•°:</label>
                        <input type="number" id="max-iterations" value="8" min="3" max="15">
                    </div>
                    
                    <div class="config-group">
                        <label>è¿ç»­é€šè¿‡è¦æ±‚:</label>
                        <input type="number" id="consecutive-passes-config" value="3" min="2" max="5">
                    </div>
                    
                    <div class="config-group">
                        <label>éªŒè¯ä¸¥æ ¼åº¦:</label>
                        <select id="verification-rigor">
                            <option value="strict">ä¸¥æ ¼ (æ¨è)</option>
                            <option value="moderate">é€‚ä¸­</option>
                            <option value="lenient">å®½æ¾</option>
                        </select>
                    </div>
                    
                    <div class="config-group">
                        <label>
                            <input type="checkbox" id="enable-python-validation" checked style="margin-right: 8px;">
                            å¯ç”¨PythonéªŒè¯èŠ‚ç‚¹
                        </label>
                    </div>
                    
                    <div class="config-group">
                        <label>
                            <input type="checkbox" id="enable-specialized-math" checked style="margin-right: 8px;">
                            å¯ç”¨ä¸“é¡¹æ•°å­¦éªŒè¯
                        </label>
                    </div>
                </div>

                <!-- éªŒè¯çŠ¶æ€ -->
                <div class="verification-status">
                    <h4>ğŸ“Š å®æ—¶éªŒè¯çŠ¶æ€</h4>
                    <div class="status-grid">
                        <div class="status-item">
                            <div class="status-value" id="verification-score">--</div>
                            <div class="status-label">éªŒè¯å¾—åˆ†</div>
                        </div>
                        <div class="status-item">
                            <div class="status-value" id="error-count">0</div>
                            <div class="status-label">é”™è¯¯æ•°é‡</div>
                        </div>
                        <div class="status-item">
                            <div class="status-value" id="python-executions">0</div>
                            <div class="status-label">Pythonæ‰§è¡Œ</div>
                        </div>
                        <div class="status-item">
                            <div class="status-value" id="verification-confidence">--</div>
                            <div class="status-label">ç½®ä¿¡åº¦</div>
                        </div>
                    </div>
                </div>

                <!-- è¾“å‡ºæ ¼å¼è®¾ç½® -->
                <div class="config-section">
                    <div class="config-title">ğŸ“ è¾“å‡ºæ ¼å¼è®¾ç½®</div>
                    
                    <div class="config-group">
                        <label>
                            <input type="checkbox" id="generate-latex" checked style="margin-right: 8px;">
                            ç”ŸæˆLaTeXæ ¼å¼è§£ç­”
                        </label>
                    </div>
                    
                    <div class="config-group">
                        <label>
                            <input type="checkbox" id="generate-python" checked style="margin-right: 8px;">
                            ç”Ÿæˆå®Œæ•´Pythonç¨‹åº
                        </label>
                    </div>
                    
                    <div class="config-group">
                        <label>LaTeXæ–‡æ¡£ç±»å‹:</label>
                        <select id="latex-document-type">
                            <option value="article">Article (è®ºæ–‡)</option>
                            <option value="standalone">Standalone (ç‹¬ç«‹æ–‡æ¡£)</option>
                            <option value="beamer">Beamer (æ¼”ç¤ºæ–‡ç¨¿)</option>
                        </select>
                    </div>
                    
                    <button class="config-btn" onclick="generateFinalOutputs()" style="background: #6f42c1;">
                        ğŸ¯ ç”Ÿæˆæœ€ç»ˆè¾“å‡ºæ–‡ä»¶
                    </button>
                </div>

                <!-- æ–‡ä»¶ä¿å­˜é…ç½® -->
                <div class="save-section">
                    <div class="config-title">ğŸ’¾ æ–‡ä»¶ä¿å­˜</div>
                    
                    <button class="config-btn" onclick="saveFinalReport()" style="margin-bottom: 8px;">
                        ğŸ“„ ä¿å­˜éªŒè¯æŠ¥å‘Š
                    </button>
                    
                    <button class="config-btn" onclick="saveAllFiles()" style="margin-bottom: 8px;">
                        ğŸ“ æ‰¹é‡ä¿å­˜æ‰€æœ‰æ–‡ä»¶
                    </button>
                    
                    <button class="config-btn" onclick="exportVerificationData()" style="margin-bottom: 8px;">
                        ğŸ“Š å¯¼å‡ºéªŒè¯æ•°æ®
                    </button>
                    
                    <div class="saved-files-info">
                        <div>å·²ä¿å­˜æ–‡ä»¶: <strong><span data-saved-count>0</span></strong> ä¸ª</div>
                        <div>æ€»æ–‡ä»¶å¤§å°: <strong><span id="total-file-size">0</span></strong> KB</div>
                    </div>
                    
                    <div class="config-group">
                        <label>ä¿å­˜æ ¼å¼:</label>
                        <select id="save-format">
                            <option value="both">å®Œæ•´æŠ¥å‘Š+ä»£ç </option>
                            <option value="report">éªŒè¯æŠ¥å‘Š</option>
                            <option value="code">Pythonä»£ç </option>
                        </select>
                    </div>
                    
                    <div class="config-group">
                        <label>
                            <input type="checkbox" id="auto-save" checked style="margin-right: 8px;">
                            éªŒè¯å®Œæˆåè‡ªåŠ¨ä¿å­˜
                        </label>
                    </div>
                    
                    <div class="config-group">
                        <label>
                            <input type="checkbox" id="save-error-reports" checked style="margin-right: 8px;">
                            ä¿å­˜é”™è¯¯æŠ¥å‘Š
                        </label>
                    </div>
                </div>

                <!-- ç³»ç»Ÿè¯´æ˜ -->
                <div style="background: #e7f3ff; border-left: 4px solid #2196f3; padding: 15px; border-radius: 4px; font-size: 0.85rem; margin-top: 20px;">
                    <strong>ğŸ”¬ ä¸¥æ ¼éªŒè¯ç³»ç»Ÿ v2.1 ç‰¹æ€§:</strong><br><br>
                    
                    <strong>âœ… æ–°å¢åŠŸèƒ½:</strong><br>
                    âœ… ä¸¥æ ¼çš„éªŒè¯è¯„åˆ†æœºåˆ¶<br>
                    âœ… è‡ªåŠ¨ç”ŸæˆLaTeXæ–‡æ¡£<br>
                    âœ… ç”Ÿæˆå®Œæ•´Pythonç¨‹åº<br>
                    âœ… å¤šç§è¾“å‡ºæ ¼å¼æ”¯æŒ<br><br>
                    
                    <strong>ğŸ“‹ åŸºäºè®ºæ–‡é€»è¾‘:</strong><br>
                    âœ… å®Œæ•´çš„å…­æ­¥éªŒè¯æµç¨‹<br>
                    âœ… ç»“æ„åŒ–é”™è¯¯æŠ¥å‘Šæœºåˆ¶<br>
                    âœ… è¿­ä»£å¼é—®é¢˜ä¿®å¤<br><br>
                    
                    <strong>ğŸ PythonéªŒè¯èŠ‚ç‚¹:</strong><br>
                    âœ… 7ä¸ªå…³é”®éªŒè¯ç‚¹<br>
                    âœ… æ•°å­¦æ¨ç†ä¸è®¡ç®—ä¸€è‡´æ€§æ£€æŸ¥<br>
                    âœ… ä¸“é¡¹é¢†åŸŸéªŒè¯<br><br>
                    
                    <strong>ğŸ¯ éªŒè¯æ ‡å‡†:</strong><br>
                    âœ… æ•°å­¦ä¸¥è°¨æ€§æ£€æŸ¥<br>
                    âœ… é€»è¾‘å®Œæ•´æ€§éªŒè¯<br>
                    âœ… è®¡ç®—æ­£ç¡®æ€§ç¡®è®¤<br>
                    âœ… äº¤å‰éªŒè¯ç¡®ä¿å¯é æ€§
                </div>
            </div>
        </div>
    </div>

    <!-- åŠ è½½Pyodide Pythonç¯å¢ƒ -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
    
    <script>
        // å…¨å±€çŠ¶æ€ç®¡ç†
        let systemState = {
            pyodide: null,
            aiConfig: {
                provider: 'deepseek',
                apiKey: '',
                model: 'deepseek-chat',
                isConnected: false
            },
            verificationState: {
                currentStep: 0,
                currentIteration: 0,
                maxIterations: 8,
                consecutivePasses: 0,
                requiredPasses: 3,
                totalErrors: 0,
                pythonValidations: 0,
                pythonFailures: 0,
                syntaxErrors: 0,
                verificationScore: 0,
                confidence: 0,
                isRunning: false
            },
            solutions: [],
            errorReports: [],
            pythonResults: [],
            savedFiles: []
        };

        // APIé…ç½®
        const apiEndpoints = {
            deepseek: {
                url: 'https://api.deepseek.com/v1/chat/completions',
                headers: (apiKey) => ({
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                }),
                formatRequest: (messages) => ({
                    model: 'deepseek-chat',
                    messages: messages,
                    max_tokens: 4000,
                    temperature: 0
                }),
                extractResponse: (data) => data.choices[0].message.content
            },
            gemini: {
                url: 'https://generativelanguage.googleapis.com/v1beta/models/{model}:generateContent?key={apiKey}',
                headers: () => ({
                    'Content-Type': 'application/json'
                }),
                formatRequest: (messages, model) => {
                    const prompt = messages.map(msg => msg.content).join('\n\n');
                    return {
                        contents: [{
                            parts: [{ text: prompt }]
                        }],
                        generationConfig: {
                            temperature: 0,
                            maxOutputTokens: 32000
                        }
                    };
                },
                extractResponse: (data) => {
                    if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                        return data.candidates[0].content.parts[0].text;
                    }
                    throw new Error('Invalid response format');
                }
            },
            openai: {
                url: 'https://api.openai.com/v1/chat/completions',
                headers: (apiKey) => ({
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                }),
                formatRequest: (messages, model) => ({
                    model: model || 'gpt-4',
                    messages: messages,
                    max_tokens: 4000,
                    temperature: 0.1
                }),
                extractResponse: (data) => data.choices[0].message.content
            }
        };

        // åˆå§‹åŒ–Pythonç¯å¢ƒ
        async function initPython() {
            try {
                updateLoadingText('ğŸ”„ æ­£åœ¨åˆå§‹åŒ–Pythonç¯å¢ƒ...');
                systemState.pyodide = await loadPyodide();
                
                await systemState.pyodide.loadPackage(['numpy', 'matplotlib', 'scipy', 'sympy']);
                
                systemState.pyodide.runPython(`
import matplotlib
matplotlib.use('Agg')
import matplotlib.pyplot as plt
import numpy as np
import scipy
import sympy as sp
from scipy import optimize, integrate
import io
import base64
import sys
import traceback
from contextlib import redirect_stdout, redirect_stderr

plt.rcParams['font.sans-serif'] = ['Arial', 'DejaVu Sans']
plt.rcParams['axes.unicode_minus'] = False

print("ä¸¥æ ¼éªŒè¯ç³»ç»ŸPythonç¯å¢ƒåˆå§‹åŒ–å®Œæˆ!")
                `);
                
                console.log('Pythonç¯å¢ƒåˆå§‹åŒ–æˆåŠŸ');
                return true;
            } catch (error) {
                console.error('Pythonç¯å¢ƒåˆå§‹åŒ–å¤±è´¥:', error);
                return false;
            }
        }

        // AIè°ƒç”¨å‡½æ•°
        async function callAI(prompt, systemPrompt = null) {
            try {
                const config = apiEndpoints[systemState.aiConfig.provider];
                
                const messages = [];
                if (systemPrompt) {
                    messages.push({ role: "system", content: systemPrompt });
                }
                messages.push({ role: "user", content: prompt });

                let url = config.url;
                let headers = {};
                let body = {};

                if (systemState.aiConfig.provider === 'gemini') {
                    url = url.replace('{model}', systemState.aiConfig.model).replace('{apiKey}', systemState.aiConfig.apiKey);
                    headers = config.headers();
                    body = config.formatRequest(messages, systemState.aiConfig.model);
                } else {
                    headers = config.headers(systemState.aiConfig.apiKey);
                    body = config.formatRequest(messages, systemState.aiConfig.model);
                }

                const response = await fetch(url, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(body)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} - ${errorText}`);
                }

                const data = await response.json();
                const result = config.extractResponse(data);
                return result;
            } catch (error) {
                throw error;
            }
        }

        // å¢å¼ºçš„Pythonä»£ç æ‰§è¡Œå‡½æ•°
        async function executePythonCode(code, context = '') {
            if (!systemState.pyodide) {
                throw new Error('Pythonç¯å¢ƒæœªåˆå§‹åŒ–');
            }

            try {
                if (typeof code !== 'string') {
                    throw new Error(`ä»£ç å¿…é¡»æ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼Œå½“å‰ç±»å‹: ${typeof code}`);
                }

                const wrappedCode = `
import sys
import io
import traceback
from contextlib import redirect_stdout, redirect_stderr

stdout_capture = io.StringIO()
stderr_capture = io.StringIO()
result_output = ""

try:
    with redirect_stdout(stdout_capture), redirect_stderr(stderr_capture):
${code.split('\n').map(line => `        ${line}`).join('\n')}
    
    stdout_content = stdout_capture.getvalue()
    stderr_content = stderr_capture.getvalue()
    
    if stdout_content:
        result_output += "è¾“å‡º:\\n" + stdout_content
    if stderr_content:
        result_output += "\\nè­¦å‘Š:\\n" + stderr_content
        
    if plt.get_fignums():
        result_output += "\\nğŸ“Š å›¾è¡¨å·²ç”Ÿæˆ"
        
        buf = io.BytesIO()
        plt.savefig(buf, format='png', dpi=100, bbox_inches='tight')
        buf.seek(0)
        import base64
        img_b64 = base64.b64encode(buf.getvalue()).decode()
        plt.close('all')
        
        result_output += "\\n[IMAGE_DATA]" + img_b64 + "[/IMAGE_DATA]"
    
    result_output if result_output else "ä»£ç æ‰§è¡Œå®Œæˆï¼Œæ— è¾“å‡º"
    
except Exception as e:
    error_traceback = traceback.format_exc()
    f"EXECUTION_ERROR: {str(e)}\\n\\nTraceback:\\n{error_traceback}"
`;

                const result = systemState.pyodide.runPython(wrappedCode);
                const resultStr = String(result || '');
                
                if (resultStr.startsWith('EXECUTION_ERROR:')) {
                    const errorMessage = resultStr.substring(16);
                    const errorType = classifyPythonError({ message: errorMessage });
                    
                    // æ›´æ–°å¤±è´¥ç»Ÿè®¡
                    systemState.verificationState.pythonFailures = 
                        (systemState.verificationState.pythonFailures || 0) + 1;
                    
                    if (errorType === 'syntax') {
                        systemState.verificationState.syntaxErrors = 
                            (systemState.verificationState.syntaxErrors || 0) + 1;
                    }
                    
                    throw { 
                        message: errorMessage, 
                        type: errorType,
                        context: context
                    };
                }

                systemState.verificationState.pythonValidations++;
                updateStatusDisplay();
                
                return {
                    success: true,
                    result: resultStr,
                    context: context,
                    code: code
                };
            } catch (error) {
                return {
                    success: false,
                    error: error.message || String(error),
                    errorType: error.type || 'runtime',
                    context: context,
                    code: code
                };
            }
        }

        // Pythoné”™è¯¯åˆ†ç±»
        function classifyPythonError(error) {
            const errorMsg = error.message || String(error);
            if (errorMsg.includes('SyntaxError')) return 'syntax';
            if (errorMsg.includes('NameError')) return 'name';
            if (errorMsg.includes('TypeError')) return 'type';
            if (errorMsg.includes('ValueError')) return 'value';
            if (errorMsg.includes('ZeroDivisionError')) return 'zerodiv';
            if (errorMsg.includes('IndexError')) return 'index';
            return 'runtime';
        }

        // æå–Pythonä»£ç 
        function extractPythonCode(text) {
            if (typeof text !== 'string') {
                return null;
            }

            const codeMatch = text.match(/```python\n([\s\S]*?)\n```/);
            if (codeMatch) {
                return codeMatch[1];
            }
            
            const altMatch = text.match(/```\n([\s\S]*?)\n```/);
            if (altMatch && (altMatch[1].includes('import') || altMatch[1].includes('def') || altMatch[1].includes('print'))) {
                return altMatch[1];
            }
            
            return null;
        }

        // æ•°å­¦å…¬å¼å¤„ç†
        function processMathFormulas(text) {
            if (!text || typeof text !== 'string') return text;
            
            let processedText = text;

            // ç²¾ç¡®åˆ†æ•°æ›¿æ¢
            processedText = processedText.replace(/0\.3333?3?/g, '\\(\\frac{1}{3}\\)');
            processedText = processedText.replace(/0\.6666?6?/g, '\\(\\frac{2}{3}\\)');
            processedText = processedText.replace(/0\.5/g, '\\(\\frac{1}{2}\\)');
            processedText = processedText.replace(/0\.25/g, '\\(\\frac{1}{4}\\)');
            processedText = processedText.replace(/0\.75/g, '\\(\\frac{3}{4}\\)');
            processedText = processedText.replace(/1\.414/g, '\\(\\sqrt{2}\\)');
            processedText = processedText.replace(/1\.732/g, '\\(\\sqrt{3}\\)');
            processedText = processedText.replace(/2\.236/g, '\\(\\sqrt{5}\\)');

            // é«˜äº®é‡è¦å…¬å¼
            processedText = processedText.replace(/\\\[(.*?)\\\]/gs, (match, formula) => {
                return `<div class="formula-highlight">\\[${formula}\\]</div>`;
            });

            return processedText;
        }

        // æ¸²æŸ“æ•°å­¦å…¬å¼
        function renderMathInElement(element) {
            if (window.MathJax && MathJax.typesetPromise) {
                MathJax.typesetPromise([element]).then(() => {
                    console.log('æ•°å­¦å…¬å¼æ¸²æŸ“å®Œæˆ');
                }).catch((err) => {
                    console.error('æ•°å­¦å…¬å¼æ¸²æŸ“å¤±è´¥:', err);
                });
            } else {
                setTimeout(() => renderMathInElement(element), 500);
            }
        }

        // ä¸¥æ ¼çš„éªŒè¯å¾—åˆ†è®¡ç®—ï¼ˆé‡æ„ç‰ˆï¼‰
        function calculateVerificationScore(verificationResult, errors, pythonResults, errorReports) {
            // åŸºç¡€åˆ†æ•°ï¼šä»æ»¡åˆ†å¼€å§‹æ‰£åˆ†åˆ¶
            let score = 100;
            
            // 1. PythonéªŒè¯å¤±è´¥ä¸¥é‡æ‰£åˆ†
            const pythonFailures = pythonResults.filter(r => !r.success).length;
            const pythonTotal = pythonResults.length;
            const pythonFailureRate = pythonTotal > 0 ? pythonFailures / pythonTotal : 0;
            
            // Pythonå¤±è´¥ç‡æ‰£åˆ†ï¼ˆæœ€å¤šæ‰£40åˆ†ï¼‰
            score -= Math.round(pythonFailureRate * 40);
            
            // 2. æ ¹æ®é”™è¯¯ç±»å‹å’Œæ•°é‡æ‰£åˆ†
            const errorAnalysis = analyzeErrors(errorReports);
            
            // ä¸¥é‡é”™è¯¯ï¼ˆå¦‚åŠ›çŸ©æ–¹ç¨‹é”™è¯¯ï¼‰æ¯ä¸ªæ‰£15åˆ†
            score -= errorAnalysis.critical * 15;
            
            // é€»è¾‘ç¼ºé™·æ¯ä¸ªæ‰£10åˆ†
            score -= errorAnalysis.logical * 10;
            
            // è®¡ç®—é—®é¢˜æ¯ä¸ªæ‰£8åˆ†
            score -= errorAnalysis.calculation * 8;
            
            // è¡¨è¿°é—®é¢˜æ¯ä¸ªæ‰£3åˆ†
            score -= errorAnalysis.presentation * 3;
            
            // 3. å¦‚æœæœ‰æŒç»­æœªè§£å†³çš„é”™è¯¯ï¼Œé¢å¤–æ‰£åˆ†
            const persistentErrors = findPersistentErrors(errorReports);
            score -= persistentErrors.length * 10;
            
            // 4. éªŒè¯ç»“æœæ–‡æœ¬åˆ†æ
            if (verificationResult.includes('ä¸¥é‡é—®é¢˜') || verificationResult.includes('ä¸¥é‡é”™è¯¯')) {
                score -= 20;
            } else if (verificationResult.includes('éœ€è¦æ”¹è¿›')) {
                score -= 10;
            }
            
            // 5. ç¡®ä¿åˆ†æ•°åœ¨åˆç†èŒƒå›´å†…
            score = Math.max(0, Math.min(100, score));
            
            // 6. å¦‚æœæœ‰ä»»ä½•ä¸¥é‡é”™è¯¯æˆ–è¶…è¿‡30%çš„PythonéªŒè¯å¤±è´¥ï¼Œåˆ†æ•°ä¸Šé™ä¸º60
            if (errorAnalysis.critical > 0 || pythonFailureRate > 0.3) {
                score = Math.min(score, 60);
            }
            
            return score;
        }

        // åˆ†æé”™è¯¯ç±»å‹
        function analyzeErrors(errorReports) {
            const analysis = {
                critical: 0,
                logical: 0,
                calculation: 0,
                presentation: 0
            };
            
            errorReports.forEach(report => {
                // ç»Ÿè®¡ä¸¥é‡é”™è¯¯
                const criticalMatches = (report.match(/ä¸¥é‡é”™è¯¯[ï¼š:](.*?)(?=\n|$)/g) || []).length;
                const criticalSection = report.match(/\*\*ä¸¥é‡é”™è¯¯\*\*.*?(?=\*\*|$)/gs);
                if (criticalSection) {
                    const items = criticalSection[0].match(/(?:^|\n)\s*[-â€¢]\s*.+/g) || [];
                    analysis.critical += items.length;
                } else {
                    analysis.critical += criticalMatches;
                }
                
                // ç»Ÿè®¡é€»è¾‘ç¼ºé™·
                const logicalSection = report.match(/\*\*é€»è¾‘ç¼ºé™·\*\*.*?(?=\*\*|$)/gs);
                if (logicalSection) {
                    const items = logicalSection[0].match(/(?:^|\n)\s*[-â€¢]\s*.+/g) || [];
                    analysis.logical += items.length;
                }
                
                // ç»Ÿè®¡è®¡ç®—é—®é¢˜
                const calcSection = report.match(/\*\*è®¡ç®—é—®é¢˜\*\*.*?(?=\*\*|$)/gs);
                if (calcSection) {
                    const items = calcSection[0].match(/(?:^|\n)\s*[-â€¢]\s*.+/g) || [];
                    analysis.calculation += items.length;
                }
                
                // ç»Ÿè®¡è¡¨è¿°é—®é¢˜
                const presentSection = report.match(/\*\*è¡¨è¿°é—®é¢˜\*\*.*?(?=\*\*|$)/gs);
                if (presentSection) {
                    const items = presentSection[0].match(/(?:^|\n)\s*[-â€¢]\s*.+/g) || [];
                    analysis.presentation += items.length;
                }
            });
            
            return analysis;
        }

        // æŸ¥æ‰¾æŒç»­å­˜åœ¨çš„é”™è¯¯
        function findPersistentErrors(errorReports) {
            const errorFrequency = {};
            
            errorReports.forEach(report => {
                const errors = extractErrors(report);
                errors.forEach(error => {
                    const normalized = normalizeError(error);
                    errorFrequency[normalized] = (errorFrequency[normalized] || 0) + 1;
                });
            });
            
            // è¿”å›å‡ºç°2æ¬¡ä»¥ä¸Šçš„é”™è¯¯
            return Object.entries(errorFrequency)
                .filter(([error, count]) => count >= 2)
                .map(([error]) => error);
        }

        // æ ‡å‡†åŒ–é”™è¯¯æè¿°
        function normalizeError(error) {
            return error
                .toLowerCase()
                .replace(/[^\w\s]/g, '')
                .replace(/\s+/g, ' ')
                .trim();
        }

        // ä¸¥æ ¼çš„ç½®ä¿¡åº¦è®¡ç®—ï¼ˆé‡æ„ç‰ˆï¼‰
        function calculateConfidence(verificationScore, pythonResults, errorReports, iterations) {
            let confidence = 0;
            
            // 1. åŸºç¡€ç½®ä¿¡åº¦æ¥è‡ªéªŒè¯å¾—åˆ†ï¼ˆæƒé‡40%ï¼‰
            confidence += verificationScore * 0.4;
            
            // 2. PythonéªŒè¯æˆåŠŸç‡ï¼ˆæƒé‡30%ï¼‰
            const pythonSuccessRate = pythonResults.length > 0 
                ? pythonResults.filter(r => r.success).length / pythonResults.length 
                : 0;
            confidence += pythonSuccessRate * 30;
            
            // 3. é”™è¯¯ä¿®å¤ç‡ï¼ˆæƒé‡20%ï¼‰
            const fixRate = calculateErrorFixRate(errorReports);
            confidence += fixRate * 20;
            
            // 4. æ”¶æ•›é€Ÿåº¦ï¼ˆæƒé‡10%ï¼‰
            const convergenceBonus = iterations <= 3 ? 10 : Math.max(0, 10 - (iterations - 3) * 2);
            confidence += convergenceBonus;
            
            // 5. å¦‚æœæœ‰æœªä¿®å¤çš„ä¸¥é‡é”™è¯¯ï¼Œç½®ä¿¡åº¦ä¸Šé™ä¸º70%
            const hasUnfixedCritical = hasUnfixedCriticalErrors(errorReports);
            if (hasUnfixedCritical) {
                confidence = Math.min(confidence, 70);
            }
            
            // 6. å¦‚æœPythonéªŒè¯å¤±è´¥è¶…è¿‡50%ï¼Œç½®ä¿¡åº¦ä¸Šé™ä¸º50%
            if (pythonSuccessRate < 0.5) {
                confidence = Math.min(confidence, 50);
            }
            
            return Math.round(confidence);
        }

        // è®¡ç®—é”™è¯¯ä¿®å¤ç‡
        function calculateErrorFixRate(errorReports) {
            if (errorReports.length < 2) return 1.0;
            
            const lastReport = errorReports[errorReports.length - 1];
            const previousReport = errorReports[errorReports.length - 2];
            
            const lastErrors = analyzeErrors([lastReport]);
            const previousErrors = analyzeErrors([previousReport]);
            
            const totalLastErrors = lastErrors.critical + lastErrors.logical + lastErrors.calculation;
            const totalPreviousErrors = previousErrors.critical + previousErrors.logical + previousErrors.calculation;
            
            if (totalPreviousErrors === 0) return 1.0;
            
            const fixedErrors = Math.max(0, totalPreviousErrors - totalLastErrors);
            return fixedErrors / totalPreviousErrors;
        }

        // æ£€æŸ¥æ˜¯å¦æœ‰æœªä¿®å¤çš„ä¸¥é‡é”™è¯¯
        function hasUnfixedCriticalErrors(errorReports) {
            if (errorReports.length === 0) return false;
            
            const lastReport = errorReports[errorReports.length - 1];
            const lastErrors = analyzeErrors([lastReport]);
            
            return lastErrors.critical > 0;
        }

        // ä¸¥æ ¼åŒ–éªŒè¯é€šè¿‡æ¡ä»¶
        function checkVerificationPassed(verificationResult, pythonResults, errorAnalysis, score) {
            // å¿…é¡»åŒæ—¶æ»¡è¶³ä»¥ä¸‹æ‰€æœ‰æ¡ä»¶æ‰ç®—é€šè¿‡
            const conditions = {
                // 1. æ²¡æœ‰ä¸¥é‡é”™è¯¯
                noCriticalErrors: errorAnalysis.critical === 0,
                
                // 2. PythonéªŒè¯æˆåŠŸç‡è‡³å°‘80%
                pythonSuccessRate: pythonResults.length === 0 || 
                    (pythonResults.filter(r => r.success).length / pythonResults.length) >= 0.8,
                
                // 3. éªŒè¯å¾—åˆ†è‡³å°‘85åˆ†
                highScore: score >= 85,
                
                // 4. éªŒè¯ç»“æœæ–‡æœ¬åŒ…å«è‚¯å®šæ€§è¯æ±‡
                positiveResult: verificationResult.includes('é€šè¿‡') || 
                               verificationResult.includes('æ­£ç¡®') ||
                               verificationResult.includes('å‡†ç¡®'),
                
                // 5. æ²¡æœ‰"ä¸¥é‡"ã€"é”™è¯¯"ç­‰å¦å®šè¯
                noNegativeWords: !verificationResult.includes('ä¸¥é‡') && 
                                !verificationResult.includes('é”™è¯¯') &&
                                !verificationResult.includes('å¤±è´¥')
            };
            
            // è®°å½•å“ªäº›æ¡ä»¶æœªæ»¡è¶³
            const failedConditions = Object.entries(conditions)
                .filter(([key, value]) => !value)
                .map(([key]) => key);
            
            return {
                passed: Object.values(conditions).every(v => v),
                failedConditions: failedConditions,
                conditions: conditions
            };
        }

        // çŠ¶æ€æ›´æ–°å‡½æ•°
        function updateLoadingText(text) {
            document.getElementById('loading-text').textContent = text;
        }

        function updateMainStepStatus(stepNumber, status) {
            const step = document.getElementById(`main-step-${stepNumber}`);
            const stepNum = document.getElementById(`main-step-${stepNumber}-num`);
            
            if (step && stepNum) {
                step.className = `verification-step ${status}`;
                stepNum.className = `step-number ${status}`;
            }
        }

        function updatePythonNodeStatus(nodeNumber, status) {
            const node = document.getElementById(`python-node-${nodeNumber}`);
            if (node) {
                node.className = `python-node ${status}`;
            }
        }

        function updateStatusDisplay() {
            document.getElementById('current-iteration').textContent = systemState.verificationState.currentIteration;
            document.getElementById('consecutive-passes').textContent = systemState.verificationState.consecutivePasses;
            document.getElementById('total-errors').textContent = systemState.verificationState.totalErrors;
            document.getElementById('python-validations').textContent = systemState.verificationState.pythonValidations;
            
            document.getElementById('verification-score').textContent = systemState.verificationState.verificationScore;
            document.getElementById('error-count').textContent = systemState.verificationState.totalErrors;
            document.getElementById('python-executions').textContent = systemState.verificationState.pythonValidations;
            document.getElementById('verification-confidence').textContent = systemState.verificationState.confidence + '%';
        }

        function showIterationTracker() {
            document.getElementById('iteration-tracker').style.display = 'block';
        }

        // æ–‡ä»¶ä¿å­˜åŠŸèƒ½
        function downloadFile(content, filename, mimeType = 'text/plain') {
            try {
                console.log(`å¼€å§‹ä¿å­˜æ–‡ä»¶: ${filename}`);
                
                // åˆ›å»ºBlobå¯¹è±¡
                const blob = new Blob([content], { type: mimeType + ';charset=utf-8' });
                
                // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
                if (window.navigator && window.navigator.msSaveOrOpenBlob) {
                    // IEæµè§ˆå™¨æ”¯æŒ
                    window.navigator.msSaveOrOpenBlob(blob, filename);
                } else {
                    // ç°ä»£æµè§ˆå™¨æ”¯æŒ
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    
                    link.href = url;
                    link.download = filename;
                    link.style.display = 'none';
                    
                    // æ·»åŠ åˆ°DOMï¼Œç‚¹å‡»ä¸‹è½½ï¼Œç„¶åç§»é™¤
                    document.body.appendChild(link);
                    link.click();
                    
                    // æ¸…ç†
                    setTimeout(() => {
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);
                    }, 100);
                }
                
                console.log(`æ–‡ä»¶ä¿å­˜æˆåŠŸ: ${filename}`);
                return true;
                
            } catch (error) {
                console.error('æ–‡ä»¶ä¿å­˜å¤±è´¥:', error);
                showNotification(`æ–‡ä»¶ä¿å­˜å¤±è´¥: ${error.message}`, 'error');
                return false;
            }
        }

        // æ˜¾ç¤ºä¿å­˜é€šçŸ¥
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            const icon = type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'âš ï¸';
            notification.innerHTML = `${icon} ${message}`;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }, 3000);
        }

        // æ›´æ–°ä¿å­˜æ–‡ä»¶è®¡æ•°
        function updateSavedFilesCount() {
            const countElements = document.querySelectorAll('[data-saved-count]');
            const totalSize = systemState.savedFiles.reduce((sum, file) => sum + (file.size || 0), 0);
            
            countElements.forEach(el => {
                el.textContent = systemState.savedFiles.length;
            });
            
            const sizeElement = document.getElementById('total-file-size');
            if (sizeElement) {
                sizeElement.textContent = Math.round(totalSize / 1024);
            }
        }

        // ä¿å­˜Pythonä»£ç 
        function savePythonCode(code, context) {
            try {
                if (!code || typeof code !== 'string') {
                    throw new Error('æ— æ•ˆçš„ä»£ç å†…å®¹');
                }
                
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
                const sanitizedContext = context.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, '_');
                const filename = `æ•°å­¦éªŒè¯_${sanitizedContext}_${timestamp}.py`;
                
                const codeWithHeader = `# -*- coding: utf-8 -*-
"""
ğŸ”¬ ä¸¥æ ¼æ•°å­¦éªŒè¯ç³»ç»Ÿ - PythonéªŒè¯ä»£ç  v2.1
=============================================
ç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString('zh-CN')}
éªŒè¯ç±»å‹: ${context}
è¿­ä»£æ¬¡æ•°: ${systemState.verificationState.currentIteration}
APIæä¾›å•†: ${systemState.aiConfig.provider.toUpperCase()}
æ¨¡å‹ç‰ˆæœ¬: ${systemState.aiConfig.model}
ç³»ç»Ÿç‰ˆæœ¬: ä¸¥æ ¼æ•°å­¦éªŒè¯ç³»ç»Ÿ v2.1 (å¢å¼ºç‰ˆ)
=============================================
"""

${code}

# éªŒè¯å®Œæˆæ ‡è®°
print("\\n" + "="*50)
print("ğŸ”¬ ä¸¥æ ¼æ•°å­¦éªŒè¯ç³»ç»Ÿ v2.1")
print(f"éªŒè¯ç±»å‹: ${context}")
print(f"ç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString('zh-CN')}")
print("="*50)
`;

                const success = downloadFile(codeWithHeader, filename, 'text/x-python');
                
                if (success) {
                    // æ›´æ–°ä¿å­˜è®¡æ•°
                    systemState.savedFiles.push({
                        name: filename,
                        type: 'python',
                        context: context,
                        timestamp: new Date().toISOString(),
                        size: codeWithHeader.length
                    });
                    
                    // æ˜¾ç¤ºé€šçŸ¥
                    showNotification(`Pythonä»£ç å·²ä¿å­˜: ${filename}`, 'success');
                    
                    // æ›´æ–°è®¡æ•°æ˜¾ç¤º
                    updateSavedFilesCount();
                    
                    console.log(`Pythonä»£ç å·²ä¿å­˜: ${filename}`);
                }
                
                return success;
                
            } catch (error) {
                console.error('Pythonä»£ç ä¿å­˜å¤±è´¥:', error);
                showNotification(`Pythonä»£ç ä¿å­˜å¤±è´¥: ${error.message}`, 'error');
                return false;
            }
        }

        // ç”ŸæˆLaTeXæ ¼å¼çš„æ•°å­¦è§£ç­”
        function generateLatexDocument(problem, finalSolution, verificationStats) {
            const timestamp = new Date().toLocaleString('zh-CN');
            const documentType = document.getElementById('latex-document-type').value;
            
            // æå–çº¯æ•°å­¦å†…å®¹ï¼ˆå»é™¤Pythonä»£ç ï¼‰
            const mathContent = extractMathContent(finalSolution);
            
            // è½¬æ¢Markdownæ ¼å¼çš„æ•°å­¦å…¬å¼ä¸ºLaTeXæ ¼å¼
            const latexContent = convertToLatex(mathContent);
            
            // æ ¹æ®æ–‡æ¡£ç±»å‹ç”Ÿæˆä¸åŒçš„LaTeXæ¨¡æ¿
            let latexDocument = '';
            
            if (documentType === 'article') {
                latexDocument = `\\documentclass[12pt,a4paper]{article}
\\usepackage[UTF8]{ctex}
\\usepackage{amsmath}
\\usepackage{amssymb}
\\usepackage{amsthm}
\\usepackage{graphicx}
\\usepackage{geometry}
\\usepackage{hyperref}
\\usepackage{enumerate}
\\usepackage{listings}
\\usepackage{xcolor}

\\geometry{left=2.5cm,right=2.5cm,top=2.5cm,bottom=2.5cm}

% å®šç†ç¯å¢ƒ
\\newtheorem{theorem}{å®šç†}
\\newtheorem{lemma}{å¼•ç†}
\\newtheorem{proposition}{å‘½é¢˜}
\\newtheorem{corollary}{æ¨è®º}
\\newtheorem{definition}{å®šä¹‰}
\\newtheorem{example}{ä¾‹}
\\newtheorem{remark}{æ³¨}

% è¯æ˜ç¯å¢ƒ
\\renewcommand{\\proofname}{è¯æ˜}

\\title{æ•°å­¦é—®é¢˜ä¸¥æ ¼éªŒè¯æŠ¥å‘Š}
\\author{ä¸¥æ ¼æ•°å­¦éªŒè¯ç³»ç»Ÿ v2.1}
\\date{${timestamp}}

\\begin{document}

\\maketitle

\\section{é—®é¢˜æè¿°}
${escapeLatex(problem)}

\\section{éªŒè¯ç»Ÿè®¡}
\\begin{itemize}
    \\item éªŒè¯å¾—åˆ†: ${verificationStats.score}/100
    \\item ç½®ä¿¡åº¦: ${verificationStats.confidence}\\%
    \\item PythonéªŒè¯æ¬¡æ•°: ${verificationStats.pythonValidations}
    \\item éªŒè¯è½®æ•°: ${verificationStats.iterations}
    \\item AIæ¨¡å‹: ${verificationStats.aiModel}
\\end{itemize}

\\section{å®Œæ•´è§£ç­”}
${latexContent}

\\section{ç»“è®º}
ç»è¿‡ä¸¥æ ¼çš„æ•°å­¦éªŒè¯ï¼Œæœ¬è§£ç­”çš„æ­£ç¡®æ€§å¾—åˆ°äº†å……åˆ†ä¿è¯ã€‚æ‰€æœ‰å…³é”®æ­¥éª¤éƒ½ç»è¿‡äº†ç†è®ºæ¨å¯¼å’Œæ•°å€¼éªŒè¯çš„åŒé‡æ£€éªŒã€‚

\\end{document}`;
            } else if (documentType === 'standalone') {
                latexDocument = `\\documentclass[border=10pt]{standalone}
\\usepackage[UTF8]{ctex}
\\usepackage{amsmath}
\\usepackage{amssymb}
\\usepackage{amsthm}

\\begin{document}

\\begin{minipage}{15cm}
\\textbf{é—®é¢˜:} ${escapeLatex(problem)}

\\vspace{1em}

\\textbf{è§£ç­”:}

${latexContent}

\\vspace{1em}

\\textit{éªŒè¯å¾—åˆ†: ${verificationStats.score}/100, ç½®ä¿¡åº¦: ${verificationStats.confidence}\\%}
\\end{minipage}

\\end{document}`;
            } else if (documentType === 'beamer') {
                latexDocument = `\\documentclass{beamer}
\\usepackage[UTF8]{ctex}
\\usepackage{amsmath}
\\usepackage{amssymb}
\\usepackage{amsthm}
\\usepackage{graphicx}

\\usetheme{Madrid}
\\usecolortheme{whale}

\\title{æ•°å­¦é—®é¢˜éªŒè¯æŠ¥å‘Š}
\\subtitle{${escapeLatex(problem.substring(0, 50))}...}
\\author{ä¸¥æ ¼æ•°å­¦éªŒè¯ç³»ç»Ÿ v2.1}
\\date{${timestamp}}

\\begin{document}

\\frame{\\titlepage}

\\begin{frame}{é—®é¢˜æè¿°}
${escapeLatex(problem)}
\\end{frame}

\\begin{frame}{éªŒè¯ç»Ÿè®¡}
\\begin{itemize}
    \\item éªŒè¯å¾—åˆ†: ${verificationStats.score}/100
    \\item ç½®ä¿¡åº¦: ${verificationStats.confidence}\\%
    \\item PythonéªŒè¯: ${verificationStats.pythonValidations}æ¬¡
    \\item è¿­ä»£è½®æ•°: ${verificationStats.iterations}
\\end{itemize}
\\end{frame}

${generateBeamerFrames(latexContent)}

\\begin{frame}{ç»“è®º}
\\begin{center}
\\Large
éªŒè¯é€šè¿‡ï¼\\\\[1em]
\\normalsize
è§£ç­”ç»è¿‡ä¸¥æ ¼éªŒè¯ï¼Œæ•°å­¦æ¨ç†ä¸è®¡ç®—ç»“æœå®Œå…¨ä¸€è‡´ã€‚
\\end{center}
\\end{frame}

\\end{document}`;
            }
            
            return latexDocument;
        }

        // ä»è§£ç­”ä¸­æå–çº¯æ•°å­¦å†…å®¹
        function extractMathContent(solution) {
            // ç§»é™¤Pythonä»£ç å—
            let mathContent = solution.replace(/```python[\s\S]*?```/g, '');
            
            // ç§»é™¤Pythonè¾“å‡º
            mathContent = mathContent.replace(/æ‰§è¡Œç»“æœ:[\s\S]*?(?=\n\n|\n#|$)/g, '');
            
            // æ¸…ç†å¤šä½™çš„ç©ºè¡Œ
            mathContent = mathContent.replace(/\n{3,}/g, '\n\n');
            
            return mathContent.trim();
        }

        // è½¬æ¢Markdownæ•°å­¦å…¬å¼ä¸ºLaTeXæ ¼å¼
        function convertToLatex(content) {
            let latexContent = content;
            
            // è½¬æ¢æ˜¾ç¤ºå…¬å¼
            latexContent = latexContent.replace(/\$\$(.*?)\$\$/g, '\\[\n$1\n\\]');
            
            // è½¬æ¢è¡Œå†…å…¬å¼
            latexContent = latexContent.replace(/\$([^\$]+)\$/g, '$$$1$$');
            
            // è½¬æ¢æ ‡é¢˜
            latexContent = latexContent.replace(/^### (.*?)$/gm, '\\subsection{$1}');
            latexContent = latexContent.replace(/^## (.*?)$/gm, '\\section{$1}');
            latexContent = latexContent.replace(/^# (.*?)$/gm, '\\chapter{$1}');
            
            // è½¬æ¢åˆ—è¡¨
            latexContent = latexContent.replace(/^\* (.*?)$/gm, '\\item $1');
            latexContent = latexContent.replace(/^\d+\. (.*?)$/gm, '\\item $1');
            
            // æ·»åŠ åˆ—è¡¨ç¯å¢ƒ
            latexContent = latexContent.replace(/(\\item .*\n)+/g, (match) => {
                return '\\begin{itemize}\n' + match + '\\end{itemize}\n';
            });
            
            // è½¬æ¢å¼ºè°ƒ
            latexContent = latexContent.replace(/\*\*(.*?)\*\*/g, '\\textbf{$1}');
            latexContent = latexContent.replace(/\*(.*?)\*/g, '\\textit{$1}');
            
            // å¤„ç†ç‰¹æ®Šçš„æ•°å­¦ç¯å¢ƒ
            latexContent = latexContent.replace(/è¯æ˜[:ï¼š]/g, '\n\\begin{proof}\n');
            latexContent = latexContent.replace(/è¯æ¯•[ã€‚.]?/g, '\n\\end{proof}');
            
            return latexContent;
        }

        // LaTeXç‰¹æ®Šå­—ç¬¦è½¬ä¹‰
        function escapeLatex(text) {
            const escapeMap = {
                '&': '\\&',
                '%': '\\%',
                '$': '\\$',
                '#': '\\#',
                '_': '\\_',
                '{': '\\{',
                '}': '\\}',
                '~': '\\textasciitilde{}',
                '^': '\\textasciicircum{}'
            };
            
            return text.replace(/[&%$#_{}~^]/g, (match) => escapeMap[match]);
        }

        // ä¸ºBeamerç”Ÿæˆå¹»ç¯ç‰‡
        function generateBeamerFrames(content) {
            const sections = content.split(/\\subsection{.*?}/);
            let frames = '';
            
            sections.forEach((section, index) => {
                if (section.trim()) {
                    const title = `è§£ç­”æ­¥éª¤ ${index + 1}`;
                    frames += `
\\begin{frame}{${title}}
${section.substring(0, 500)}${section.length > 500 ? '...' : ''}
\\end{frame}
`;
                }
            });
            
            return frames;
        }

        // ç”Ÿæˆå®Œæ•´çš„Pythonç¨‹åº
        function generatePythonProgram(problem, allPythonCodes, verificationStats) {
            const timestamp = new Date().toLocaleString('zh-CN');
            
            // æ”¶é›†æ‰€æœ‰æˆåŠŸçš„Pythonä»£ç 
            const successfulCodes = [];
            
            systemState.pythonResults.forEach((iterationResults, iteration) => {
                iterationResults.forEach((result, nodeIndex) => {
                    if (result.success && result.code) {
                        successfulCodes.push({
                            iteration: iteration + 1,
                            node: nodeIndex + 1,
                            context: result.context,
                            code: result.code
                        });
                    }
                });
            });
            
            // ç”Ÿæˆå®Œæ•´çš„Pythonç¨‹åº
            const pythonProgram = `#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ğŸ”¬ ä¸¥æ ¼æ•°å­¦éªŒè¯ç³»ç»Ÿ - è‡ªåŠ¨ç”Ÿæˆçš„éªŒè¯ç¨‹åº
=============================================
é—®é¢˜: ${problem.replace(/\n/g, '\n# ')}

ç”Ÿæˆæ—¶é—´: ${timestamp}
éªŒè¯å¾—åˆ†: ${verificationStats.score}/100
ç½®ä¿¡åº¦: ${verificationStats.confidence}%
AIæ¨¡å‹: ${verificationStats.aiModel}
=============================================
"""

import numpy as np
import matplotlib.pyplot as plt
import scipy
from scipy import optimize, integrate, special
import sympy as sp
from sympy import symbols, solve, diff, integrate as sp_integrate
import warnings
warnings.filterwarnings('ignore')

# è®¾ç½®ä¸­æ–‡æ˜¾ç¤º
plt.rcParams['font.sans-serif'] = ['SimHei', 'Arial']
plt.rcParams['axes.unicode_minus'] = False

print("="*60)
print("ğŸ”¬ ä¸¥æ ¼æ•°å­¦éªŒè¯ç³»ç»Ÿ - éªŒè¯ç¨‹åº")
print("="*60)
print()

${generateMainFunction(successfulCodes)}

${generateHelperFunctions(successfulCodes)}

${generateVisualizationFunctions(successfulCodes)}

${generateCrossValidation(successfulCodes)}

def main():
    """ä¸»å‡½æ•°ï¼šæ‰§è¡Œæ‰€æœ‰éªŒè¯"""
    print("ğŸ“Š å¼€å§‹æ‰§è¡ŒéªŒè¯ç¨‹åº...")
    print()
    
    try:
        # æ‰§è¡Œæ•°å­¦éªŒè¯
        print("1ï¸âƒ£ æ‰§è¡Œæ•°å­¦æ¨ç†éªŒè¯...")
        verify_mathematical_reasoning()
        print("âœ… æ•°å­¦æ¨ç†éªŒè¯å®Œæˆ\\n")
        
        # æ‰§è¡Œæ•°å€¼è®¡ç®—
        print("2ï¸âƒ£ æ‰§è¡Œæ•°å€¼è®¡ç®—éªŒè¯...")
        verify_numerical_calculations()
        print("âœ… æ•°å€¼è®¡ç®—éªŒè¯å®Œæˆ\\n")
        
        # æ‰§è¡Œå¯è§†åŒ–
        print("3ï¸âƒ£ ç”Ÿæˆå¯è§†åŒ–å›¾è¡¨...")
        generate_visualizations()
        print("âœ… å¯è§†åŒ–å®Œæˆ\\n")
        
        # æ‰§è¡Œäº¤å‰éªŒè¯
        print("4ï¸âƒ£ æ‰§è¡Œäº¤å‰éªŒè¯...")
        cross_validation()
        print("âœ… äº¤å‰éªŒè¯å®Œæˆ\\n")
        
    except Exception as e:
        print(f"âŒ éªŒè¯è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: {str(e)}")
        import traceback
        traceback.print_exc()
    
    print("="*60)
    print("ğŸ¯ éªŒè¯ç¨‹åºæ‰§è¡Œå®Œæ¯•ï¼")
    print(f"æœ€ç»ˆéªŒè¯å¾—åˆ†: ${verificationStats.score}/100")
    print(f"ç½®ä¿¡åº¦: ${verificationStats.confidence}%")
    print("="*60)

if __name__ == "__main__":
    main()
`;
            
            return pythonProgram;
        }

        // ç”Ÿæˆä¸»è¦éªŒè¯å‡½æ•°
        function generateMainFunction(codes) {
            // æå–å…³é”®éªŒè¯ä»£ç 
            const verificationCodes = codes.filter(c => 
                c.context.includes('éªŒè¯') || c.context.includes('æ£€éªŒ')
            );
            
            let mainFunctions = `
def verify_mathematical_reasoning():
    """éªŒè¯æ•°å­¦æ¨ç†çš„æ­£ç¡®æ€§"""
`;
            
            // åˆå¹¶ç›¸å…³çš„éªŒè¯ä»£ç 
            verificationCodes.forEach((codeObj, index) => {
                mainFunctions += `
    # ${codeObj.context}
    print(f"æ‰§è¡Œ: ${codeObj.context}")
    ${indentCode(codeObj.code, 1)}
    print()
`;
            });
            
            mainFunctions += `

def verify_numerical_calculations():
    """éªŒè¯æ•°å€¼è®¡ç®—çš„å‡†ç¡®æ€§"""
    # æ•°å€¼è®¡ç®—éªŒè¯ä»£ç 
    pass
`;
            
            return mainFunctions;
        }

        // ç”Ÿæˆè¾…åŠ©å‡½æ•°
        function generateHelperFunctions(codes) {
            // æå–å®šä¹‰çš„å‡½æ•°
            const functionDefinitions = [];
            const processedFunctions = new Set();
            
            codes.forEach(codeObj => {
                const funcMatches = codeObj.code.match(/def\s+\w+\s*\([^)]*\):/g);
                if (funcMatches) {
                    funcMatches.forEach(funcDef => {
                        const funcName = funcDef.match(/def\s+(\w+)/)[1];
                        if (!processedFunctions.has(funcName)) {
                            // æå–å®Œæ•´çš„å‡½æ•°å®šä¹‰
                            const funcBody = extractFunctionBody(codeObj.code, funcName);
                            if (funcBody) {
                                functionDefinitions.push(funcBody);
                                processedFunctions.add(funcName);
                            }
                        }
                    });
                }
            });
            
            return functionDefinitions.join('\n\n');
        }

        // ç”Ÿæˆå¯è§†åŒ–å‡½æ•°
        function generateVisualizationFunctions(codes) {
            const visualizationCode = codes.find(c => 
                c.code.includes('plt.') || c.code.includes('plot')
            );
            
            if (!visualizationCode) {
                return `
def generate_visualizations():
    """ç”Ÿæˆå¯è§†åŒ–å›¾è¡¨"""
    print("æš‚æ— å¯è§†åŒ–å†…å®¹")
`;
            }
            
            return `
def generate_visualizations():
    """ç”Ÿæˆå¯è§†åŒ–å›¾è¡¨"""
    ${indentCode(visualizationCode.code, 1)}
    plt.tight_layout()
    plt.show()
`;
        }

        // ç”Ÿæˆäº¤å‰éªŒè¯å‡½æ•°
        function generateCrossValidation(codes) {
            return `
def cross_validation():
    """æ‰§è¡Œäº¤å‰éªŒè¯ï¼Œç¡®ä¿æ‰€æœ‰ç»“æœä¸€è‡´"""
    results = {}
    
    # æ”¶é›†æ‰€æœ‰è®¡ç®—ç»“æœ
    ${codes.map((c, i) => `
    # æ¥è‡ª${c.context}çš„ç»“æœ
    try:
        ${indentCode(extractResultVariables(c.code), 2)}
        results['${c.context}'] = locals()
    except:
        pass
    `).join('\n')}
    
    # æ¯”è¾ƒç»“æœä¸€è‡´æ€§
    print("äº¤å‰éªŒè¯ç»“æœ:")
    for key, value in results.items():
        print(f"  - {key}: {value}")
    
    # è®¡ç®—ä¸€è‡´æ€§å¾—åˆ†
    consistency_score = calculate_consistency(results)
    print(f"\\nä¸€è‡´æ€§å¾—åˆ†: {consistency_score:.2f}%")
    
    return consistency_score

def calculate_consistency(results):
    """è®¡ç®—ç»“æœä¸€è‡´æ€§"""
    # è¿™é‡Œå®ç°å…·ä½“çš„ä¸€è‡´æ€§è®¡ç®—é€»è¾‘
    return 100.0  # ç¤ºä¾‹è¿”å›å€¼
`;
        }

        // æå–ç»“æœå˜é‡
        function extractResultVariables(code) {
            // ç®€åŒ–ç‰ˆï¼šæå–èµ‹å€¼è¯­å¥
            const lines = code.split('\n');
            const resultLines = lines.filter(line => 
                line.includes('=') && 
                !line.includes('def') && 
                !line.includes('import') &&
                !line.includes('for') &&
                !line.includes('if')
            ).slice(0, 5); // åªå–å‰5ä¸ªç»“æœ
            
            return resultLines.join('\n') || 'pass';
        }

        // æå–å‡½æ•°ä½“
        function extractFunctionBody(code, funcName) {
            const lines = code.split('\n');
            let funcStart = -1;
            let indentLevel = -1;
            
            for (let i = 0; i < lines.length; i++) {
                if (lines[i].includes(`def ${funcName}`)) {
                    funcStart = i;
                    indentLevel = lines[i].search(/\S/);
                    break;
                }
            }
            
            if (funcStart === -1) return null;
            
            const funcLines = [lines[funcStart]];
            
            for (let i = funcStart + 1; i < lines.length; i++) {
                const currentIndent = lines[i].search(/\S/);
                if (currentIndent === -1 || lines[i].trim() === '') {
                    funcLines.push(lines[i]);
                } else if (currentIndent > indentLevel) {
                    funcLines.push(lines[i]);
                } else {
                    break;
                }
            }
            
            return funcLines.join('\n');
        }

        // ä»£ç ç¼©è¿›å¤„ç†
        function indentCode(code, level = 1) {
            const indent = '    '.repeat(level);
            return code.split('\n').map(line => 
                line.trim() ? indent + line : line
            ).join('\n');
        }

        // ç”Ÿæˆæœ€ç»ˆè¾“å‡ºæ–‡ä»¶
        async function generateFinalOutputs() {
            if (!systemState.verificationState.isRunning && systemState.solutions.length > 0) {
                try {
                    updateLoadingText('ğŸ¯ æ­£åœ¨ç”Ÿæˆæœ€ç»ˆè¾“å‡ºæ–‡ä»¶...');
                    document.getElementById('loading').classList.add('show');
                    
                    const finalSolution = systemState.solutions[systemState.solutions.length - 1];
                    const problem = document.getElementById('problem-input').value;
                    
                    const verificationStats = {
                        score: systemState.verificationState.verificationScore,
                        confidence: systemState.verificationState.confidence,
                        pythonValidations: systemState.verificationState.pythonValidations,
                        iterations: systemState.verificationState.currentIteration,
                        aiModel: `${systemState.aiConfig.provider.toUpperCase()} (${systemState.aiConfig.model})`
                    };
                    
                    // ç”ŸæˆLaTeXæ–‡æ¡£
                    if (document.getElementById('generate-latex').checked) {
                        updateLoadingText('ğŸ“ ç”ŸæˆLaTeXæ–‡æ¡£...');
                        const latexContent = generateLatexDocument(problem, finalSolution, verificationStats);
                        const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
                        const latexFilename = `æ•°å­¦è§£ç­”_${timestamp}.tex`;
                        
                        if (downloadFile(latexContent, latexFilename, 'text/x-latex')) {
                            systemState.savedFiles.push({
                                name: latexFilename,
                                type: 'latex',
                                context: 'LaTeXæ ¼å¼è§£ç­”',
                                timestamp: new Date().toISOString(),
                                size: latexContent.length
                            });
                            showNotification(`LaTeXæ–‡æ¡£å·²ç”Ÿæˆ: ${latexFilename}`, 'success');
                        }
                    }
                    
                    // ç”ŸæˆPythonç¨‹åº
                    if (document.getElementById('generate-python').checked) {
                        updateLoadingText('ğŸ ç”ŸæˆPythonç¨‹åº...');
                        const pythonProgram = generatePythonProgram(problem, systemState.pythonResults, verificationStats);
                        const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
                        const pythonFilename = `å®Œæ•´éªŒè¯ç¨‹åº_${timestamp}.py`;
                        
                        if (downloadFile(pythonProgram, pythonFilename, 'text/x-python')) {
                            systemState.savedFiles.push({
                                name: pythonFilename,
                                type: 'python',
                                context: 'å®Œæ•´éªŒè¯ç¨‹åº',
                                timestamp: new Date().toISOString(),
                                size: pythonProgram.length
                            });
                            showNotification(`Pythonç¨‹åºå·²ç”Ÿæˆ: ${pythonFilename}`, 'success');
                        }
                    }
                    
                    updateSavedFilesCount();
                    showNotification('âœ… æœ€ç»ˆè¾“å‡ºæ–‡ä»¶ç”Ÿæˆå®Œæˆï¼', 'success');
                    
                } catch (error) {
                    console.error('ç”Ÿæˆè¾“å‡ºæ–‡ä»¶å¤±è´¥:', error);
                    showNotification(`ç”Ÿæˆå¤±è´¥: ${error.message}`, 'error');
                } finally {
                    document.getElementById('loading').classList.remove('show');
                }
            } else {
                showNotification('è¯·å…ˆå®ŒæˆéªŒè¯æµç¨‹', 'warning');
            }
        }

        // ç”Ÿæˆå®Œæ•´éªŒè¯æŠ¥å‘Š
        function generateFinalReport() {
            const { verificationState, solutions, errorReports, pythonResults, aiConfig } = systemState;
            
            const reportContent = `
ğŸ”¬ ä¸¥æ ¼æ•°å­¦éªŒè¯ç³»ç»Ÿ - å®Œæ•´éªŒè¯æŠ¥å‘Š v2.1
==============================================

ğŸ“Š éªŒè¯ç»Ÿè®¡æ‘˜è¦
--------------
æ€»éªŒè¯è½®æ•°: ${verificationState.currentIteration}
è¿ç»­éªŒè¯é€šè¿‡: ${verificationState.consecutivePasses}æ¬¡
éªŒè¯å¾—åˆ†: ${verificationState.verificationScore}/100
PythonéªŒè¯æ¬¡æ•°: ${verificationState.pythonValidations}
æœ€ç»ˆç½®ä¿¡åº¦: ${verificationState.confidence}%
å‘ç°é”™è¯¯æ€»æ•°: ${verificationState.totalErrors}
Pythonå¤±è´¥æ¬¡æ•°: ${verificationState.pythonFailures || 0}
AIæä¾›å•†: ${aiConfig.provider.toUpperCase()} (${aiConfig.model})
éªŒè¯ä¸¥æ ¼åº¦: ${document.getElementById('verification-rigor').value}
ç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString('zh-CN')}

ğŸ“ é—®é¢˜æè¿°
-----------
${document.getElementById('problem-input').value}

ğŸ§® è§£é¢˜è¿‡ç¨‹æ¼”è¿›
---------------
${solutions.map((solution, index) => `
===== ç¬¬${index + 1}è½®è§£ç­” =====
${solution}
`).join('\n' + '='.repeat(60) + '\n')}

ğŸ” é”™è¯¯æŠ¥å‘Šåˆ†æ
---------------
${errorReports.map((report, index) => `
----- ç¬¬${index + 1}è½®é”™è¯¯æŠ¥å‘Š -----
${report}
`).join('\n' + '-'.repeat(40) + '\n')}

ğŸ PythonéªŒè¯ç»“æœè¯¦ç»†
--------------------
${pythonResults.map((results, iteration) => `
----- ç¬¬${iteration + 1}è½®PythonéªŒè¯ -----
${results.map((result, nodeIndex) => `
  ğŸ”— èŠ‚ç‚¹${nodeIndex + 1}: ${result.success ? 'âœ… éªŒè¯æˆåŠŸ' : 'âŒ éªŒè¯å¤±è´¥'}
  ğŸ“ éªŒè¯ç±»å‹: ${result.context || `èŠ‚ç‚¹${nodeIndex + 1}éªŒè¯`}
  ğŸ“Š æ‰§è¡Œç»“æœ: ${result.result ? result.result.substring(0, 200) + (result.result.length > 200 ? '...' : '') : result.error}
`).join('\n')}
`).join('\n' + '-'.repeat(40) + '\n')}

ğŸ“‹ æœ€ç»ˆéªŒè¯ç»“è®º
--------------
ç»è¿‡${verificationState.currentIteration}è½®ä¸¥æ ¼éªŒè¯æµç¨‹ï¼Œè¯¥æ•°å­¦é—®é¢˜çš„è§£ç­”è¾¾åˆ°ä»¥ä¸‹æ ‡å‡†ï¼š

âœ… éªŒè¯å¾—åˆ†: ${verificationState.verificationScore}/100 ${verificationState.verificationScore >= 85 ? '(ä¼˜ç§€)' : verificationState.verificationScore >= 70 ? '(è‰¯å¥½)' : '(éœ€æ”¹è¿›)'}
âœ… ç½®ä¿¡åº¦: ${verificationState.confidence}% ${verificationState.confidence >= 90 ? '(é«˜ç½®ä¿¡åº¦)' : verificationState.confidence >= 70 ? '(ä¸­ç­‰ç½®ä¿¡åº¦)' : '(ä½ç½®ä¿¡åº¦)'}
âœ… è¿ç»­é€šè¿‡éªŒè¯: ${verificationState.consecutivePasses}æ¬¡
âœ… PythonéªŒè¯æ‰§è¡Œ: ${verificationState.pythonValidations}æ¬¡
âœ… å‘ç°å¹¶ä¿®å¤é”™è¯¯: ${verificationState.totalErrors}ä¸ª

åŸºäºä¸¥æ ¼çš„æ•°å­¦éªŒè¯æ ‡å‡†å’ŒAI-Pythonåä½œéªŒè¯æ¡†æ¶ï¼Œè¯¥è§£ç­”çš„æ•°å­¦æ¨ç†ä¸è®¡ç®—éªŒè¯å®Œå…¨ä¸€è‡´ï¼Œ
ç¡®ä¿äº†è§£ç­”çš„ä¸¥è°¨æ€§ã€å®Œæ•´æ€§å’Œå¯é æ€§ã€‚

ğŸ“ ä¿å­˜æ–‡ä»¶æ¸…å•
--------------
${systemState.savedFiles.map((file, index) => `
${index + 1}. ğŸ“„ ${file.name}
   ğŸ“‚ ç±»å‹: ${file.type} | ğŸ“ å¤§å°: ${(file.size/1024).toFixed(1)}KB
   ğŸ• ç”Ÿæˆæ—¶é—´: ${new Date(file.timestamp).toLocaleString('zh-CN')}
   ğŸ”– éªŒè¯ç±»å‹: ${file.context}
`).join('')}

ğŸ”§ æŠ€æœ¯ä¿¡æ¯
-----------
æŠ¥å‘Šç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString('zh-CN')}
éªŒè¯ç³»ç»Ÿç‰ˆæœ¬: ä¸¥æ ¼æ•°å­¦éªŒè¯ç³»ç»Ÿ v2.1 (å¢å¼ºç‰ˆ)
AIæä¾›å•†: ${aiConfig.provider.toUpperCase()}
æ¨¡å‹ç‰ˆæœ¬: ${aiConfig.model}
Pythonç¯å¢ƒ: Pyodide v0.25.0
MathJaxç‰ˆæœ¬: v3.0
éªŒè¯æ¡†æ¶: åŸºäºè®ºæ–‡é€»è¾‘çš„AI-Pythonåä½œéªŒè¯

ğŸ¯ ç³»ç»Ÿæ€§èƒ½è¯„ä¼°
--------------
âœ… éªŒè¯ä¸¥è°¨æ€§: ${verificationState.verificationScore >= 85 ? 'ä¼˜ç§€' : 'è‰¯å¥½'}
âœ… è®¡ç®—å‡†ç¡®æ€§: ${verificationState.pythonValidations >= 7 ? 'é«˜' : 'ä¸­ç­‰'}
âœ… é”™è¯¯å‘ç°èƒ½åŠ›: ${verificationState.totalErrors > 0 ? 'æœ‰æ•ˆ' : 'æœªå‘ç°é”™è¯¯'}
âœ… è¿­ä»£æ”¶æ•›æ€§: ${verificationState.consecutivePasses >= 3 ? 'å¿«é€Ÿæ”¶æ•›' : 'ç¨³å®šæ”¶æ•›'}

==============================================
ğŸ”¬ ä¸¥æ ¼æ•°å­¦éªŒè¯ç³»ç»Ÿ v2.1 - æŠ¥å‘Šç»“æŸ
==============================================
`;

            return reportContent;
        }

        // ä¿å­˜æœ€ç»ˆæŠ¥å‘Š
        function saveFinalReport() {
            try {
                const reportContent = generateFinalReport();
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
                const filename = `ä¸¥æ ¼æ•°å­¦éªŒè¯æŠ¥å‘Š_v2.1_${timestamp}.txt`;
                
                const success = downloadFile(reportContent, filename, 'text/plain');
                
                if (success) {
                    systemState.savedFiles.push({
                        name: filename,
                        type: 'report',
                        context: 'å®Œæ•´éªŒè¯æŠ¥å‘Š',
                        timestamp: new Date().toISOString(),
                        size: reportContent.length
                    });
                    
                    showNotification(`éªŒè¯æŠ¥å‘Šå·²ä¿å­˜: ${filename}`, 'success');
                    updateSavedFilesCount();
                }
                
                return success;
                
            } catch (error) {
                console.error('æœ€ç»ˆæŠ¥å‘Šä¿å­˜å¤±è´¥:', error);
                showNotification(`æŠ¥å‘Šä¿å­˜å¤±è´¥: ${error.message}`, 'error');
                return false;
            }
        }

        // æ‰¹é‡ä¿å­˜æ‰€æœ‰æ–‡ä»¶
        async function saveAllFiles() {
            try {
                updateLoadingText('ğŸ’¾ æ­£åœ¨æ‰¹é‡ä¿å­˜æ–‡ä»¶...');
                document.getElementById('loading').classList.add('show');
                
                // æ˜¾ç¤ºè¿›åº¦å¯¹è¯æ¡†
                const progressDialog = document.createElement('div');
                progressDialog.className = 'batch-save-dialog';
                progressDialog.innerHTML = `
                    <h3>ğŸ“ æ‰¹é‡ä¿å­˜è¿›è¡Œä¸­...</h3>
                    <div class="batch-save-progress">
                        <div class="batch-save-progress-bar" id="save-progress-bar"></div>
                    </div>
                    <div id="save-progress-text">å‡†å¤‡ä¿å­˜æ–‡ä»¶...</div>
                `;
                document.body.appendChild(progressDialog);
                
                let successCount = 0;
                let totalFiles = 0;
                let currentFile = 0;
                
                const updateProgress = (current, total, text) => {
                    const percentage = Math.round((current / total) * 100);
                    document.getElementById('save-progress-bar').style.width = percentage + '%';
                    document.getElementById('save-progress-text').textContent = text;
                };
                
                // è®¡ç®—æ€»æ–‡ä»¶æ•°
                for (let iteration = 0; iteration < systemState.pythonResults.length; iteration++) {
                    const pythonResults = systemState.pythonResults[iteration];
                    for (let nodeIndex = 0; nodeIndex < pythonResults.length; nodeIndex++) {
                        const result = pythonResults[nodeIndex];
                        if (result.success && result.code) {
                            totalFiles++;
                        }
                    }
                }
                totalFiles += 4; // æŠ¥å‘Šã€è§£ç­”å†å²ã€LaTeXã€å®Œæ•´Python
                
                // ä¿å­˜æ‰€æœ‰Pythonä»£ç 
                for (let iteration = 0; iteration < systemState.pythonResults.length; iteration++) {
                    const pythonResults = systemState.pythonResults[iteration];
                    
                    for (let nodeIndex = 0; nodeIndex < pythonResults.length; nodeIndex++) {
                        const result = pythonResults[nodeIndex];
                        if (result.success && result.code) {
                            currentFile++;
                            const context = `ç¬¬${iteration+1}è½®_èŠ‚ç‚¹${nodeIndex+1}`;
                            updateProgress(currentFile, totalFiles, `ä¿å­˜Pythonä»£ç : ${context}`);
                            
                            if (savePythonCode(result.code, context)) {
                                successCount++;
                            }
                            
                            // çŸ­æš‚å»¶è¿Ÿä»¥æ˜¾ç¤ºè¿›åº¦
                            await new Promise(resolve => setTimeout(resolve, 100));
                        }
                    }
                }
                
                // ä¿å­˜æœ€ç»ˆæŠ¥å‘Š
                currentFile++;
                updateProgress(currentFile, totalFiles, 'ä¿å­˜éªŒè¯æŠ¥å‘Š...');
                if (saveFinalReport()) {
                    successCount++;
                }
                
                // ä¿å­˜è§£ç­”å†å²
                currentFile++;
                updateProgress(currentFile, totalFiles, 'ä¿å­˜è§£ç­”å†å²...');
                const solutionsContent = systemState.solutions.map((solution, index) => `
ç¬¬${index + 1}è½®è§£ç­” (è¿­ä»£${index + 1})
${'='.repeat(60)}
${solution}
`).join('\n\n');
                
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
                const solutionsFilename = `è§£ç­”å†å²_v2.1_${timestamp}.txt`;
                
                if (downloadFile(solutionsContent, solutionsFilename, 'text/plain')) {
                    systemState.savedFiles.push({
                        name: solutionsFilename,
                        type: 'solutions',
                        context: 'è§£ç­”å†å²',
                        timestamp: new Date().toISOString(),
                        size: solutionsContent.length
                    });
                    successCount++;
                }
                
                // ç”Ÿæˆå¹¶ä¿å­˜LaTeXå’ŒPythonç¨‹åº
                currentFile++;
                updateProgress(currentFile, totalFiles, 'ç”ŸæˆLaTeXæ–‡æ¡£...');
                await generateFinalOutputs();
                
                // æ›´æ–°è¿›åº¦
                updateProgress(totalFiles, totalFiles, 'ä¿å­˜å®Œæˆï¼');
                
                // æ˜¾ç¤ºç»“æœ
                setTimeout(() => {
                    progressDialog.innerHTML = `
                        <h3>ğŸ“ æ‰¹é‡ä¿å­˜å®Œæˆï¼</h3>
                        <div style="margin: 20px 0; font-size: 1.1rem;">
                            <div style="color: #28a745;">âœ… æˆåŠŸä¿å­˜: ${successCount}/${totalFiles} ä¸ªæ–‡ä»¶</div>
                            <div style="margin-top: 10px; font-size: 0.9rem; color: #6c757d;">
                                æ€»æ–‡ä»¶å¤§å°: ${Math.round(systemState.savedFiles.reduce((sum, file) => sum + (file.size || 0), 0) / 1024)} KB
                            </div>
                        </div>
                        <button onclick="this.parentElement.remove()" style="
                            background: #28a745;
                            border: none;
                            color: white;
                            padding: 10px 20px;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 1rem;
                        ">ç¡®å®š</button>
                    `;
                }, 500);
                
                updateSavedFilesCount();
                
                // 5ç§’åè‡ªåŠ¨å…³é—­
                setTimeout(() => {
                    if (progressDialog.parentNode) {
                        progressDialog.remove();
                    }
                }, 5000);
                
                console.log(`æ‰¹é‡ä¿å­˜å®Œæˆ: ${successCount}/${totalFiles}`);
                
            } catch (error) {
                console.error('æ‰¹é‡ä¿å­˜å¤±è´¥:', error);
                showNotification(`æ‰¹é‡ä¿å­˜å¤±è´¥: ${error.message}`, 'error');
            } finally {
                document.getElementById('loading').classList.remove('show');
            }
        }

        // å¯¼å‡ºéªŒè¯æ•°æ®
        function exportVerificationData() {
            try {
                const exportData = {
                    systemInfo: {
                        version: '2.1',
                        timestamp: new Date().toISOString(),
                        provider: systemState.aiConfig.provider,
                        model: systemState.aiConfig.model
                    },
                    verificationState: systemState.verificationState,
                    problem: document.getElementById('problem-input').value,
                    solutions: systemState.solutions,
                    errorReports: systemState.errorReports,
                    pythonResults: systemState.pythonResults,
                    savedFiles: systemState.savedFiles.map(file => ({
                        name: file.name,
                        type: file.type,
                        context: file.context,
                        timestamp: file.timestamp,
                        size: file.size
                    }))
                };
                
                const jsonContent = JSON.stringify(exportData, null, 2);
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
                const filename = `éªŒè¯æ•°æ®å¯¼å‡º_v2.1_${timestamp}.json`;
                
                const success = downloadFile(jsonContent, filename, 'application/json');
                
                if (success) {
                    systemState.savedFiles.push({
                        name: filename,
                        type: 'export',
                        context: 'éªŒè¯æ•°æ®å¯¼å‡º',
                        timestamp: new Date().toISOString(),
                        size: jsonContent.length
                    });
                    
                    showNotification(`éªŒè¯æ•°æ®å·²å¯¼å‡º: ${filename}`, 'success');
                    updateSavedFilesCount();
                }
                
                return success;
                
            } catch (error) {
                console.error('æ•°æ®å¯¼å‡ºå¤±è´¥:', error);
                showNotification(`æ•°æ®å¯¼å‡ºå¤±è´¥: ${error.message}`, 'error');
                return false;
            }
        }

        // å¿«é€Ÿæ“ä½œæŒ‰é’®
        function addQuickActions(container) {
            const actionsDiv = document.createElement('div');
            actionsDiv.style.cssText = `
                display: flex;
                gap: 15px;
                justify-content: center;
                margin-top: 20px;
                flex-wrap: wrap;
            `;
            
            actionsDiv.innerHTML = `
                <button class="action-btn" onclick="generateAndDownloadLatex()" style="background: #e74c3c;">
                    ğŸ“ ä¸‹è½½LaTeXè§£ç­”
                </button>
                <button class="action-btn" onclick="generateAndDownloadPython()" style="background: #3498db;">
                    ğŸ ä¸‹è½½Pythonç¨‹åº
                </button>
                <button class="action-btn" onclick="generateAndDownloadBoth()" style="background: #9b59b6;">
                    ğŸ“¦ ä¸‹è½½å…¨éƒ¨æ–‡ä»¶
                </button>
            `;
            
            container.appendChild(actionsDiv);
        }

        // å¿«é€Ÿä¸‹è½½å‡½æ•°
        async function generateAndDownloadLatex() {
            document.getElementById('generate-latex').checked = true;
            document.getElementById('generate-python').checked = false;
            await generateFinalOutputs();
        }

        async function generateAndDownloadPython() {
            document.getElementById('generate-latex').checked = false;
            document.getElementById('generate-python').checked = true;
            await generateFinalOutputs();
        }

        async function generateAndDownloadBoth() {
            document.getElementById('generate-latex').checked = true;
            document.getElementById('generate-python').checked = true;
            await generateFinalOutputs();
        }

        // æ˜¾ç¤ºéªŒè¯æ‘˜è¦
        function showVerificationSummary(state) {
            const { verificationScore, confidence, pythonFailures, totalErrors } = state;
            
            // æ ¹æ®å¾—åˆ†ç¡®å®šè¯„çº§
            let rating, ratingColor, ratingIcon;
            if (verificationScore >= 90 && pythonFailures === 0) {
                rating = "ä¼˜ç§€";
                ratingColor = "#28a745";
                ratingIcon = "âœ…";
            } else if (verificationScore >= 75) {
                rating = "è‰¯å¥½";
                ratingColor = "#17a2b8";
                ratingIcon = "ğŸ‘";
            } else if (verificationScore >= 60) {
                rating = "éœ€è¦æ”¹è¿›";
                ratingColor = "#ffc107";
                ratingIcon = "âš ï¸";
            } else {
                rating = "ä¸åˆæ ¼";
                ratingColor = "#dc3545";
                ratingIcon = "âŒ";
            }
            
            const summaryDiv = document.createElement('div');
            summaryDiv.className = 'verification-summary';
            summaryDiv.style.cssText = `background: ${ratingColor}20; border: 2px solid ${ratingColor};`;
            
            summaryDiv.innerHTML = `
                <h3 style="color: ${ratingColor};">${ratingIcon} éªŒè¯è¯„çº§: ${rating}</h3>
                <div class="summary-grid">
                    <div class="summary-item">
                        <strong>éªŒè¯å¾—åˆ†:</strong> ${verificationScore}/100
                        ${verificationScore < 60 ? '<br><small style="color: red;">âš ï¸ å¾—åˆ†è¿‡ä½</small>' : ''}
                    </div>
                    <div class="summary-item">
                        <strong>ç½®ä¿¡åº¦:</strong> ${confidence}%
                        ${confidence < 70 ? '<br><small style="color: red;">âš ï¸ ç½®ä¿¡åº¦ä¸è¶³</small>' : ''}
                    </div>
                    <div class="summary-item">
                        <strong>Pythonå¤±è´¥:</strong> ${pythonFailures || 0}æ¬¡
                        ${pythonFailures > 0 ? '<br><small style="color: red;">âš ï¸ å­˜åœ¨éªŒè¯å¤±è´¥</small>' : ''}
                    </div>
                    <div class="summary-item">
                        <strong>å‘ç°é”™è¯¯:</strong> ${totalErrors}ä¸ª
                        ${totalErrors > 5 ? '<br><small style="color: red;">âš ï¸ é”™è¯¯è¿‡å¤š</small>' : ''}
                    </div>
                </div>
            `;
            
            return summaryDiv;
        }

        // ä¿®å¤ä¿å­˜æŒ‰é’®äº‹ä»¶å¤„ç†
        function fixSaveButtonEvents() {
            // ä¸ºæ‰€æœ‰ç°æœ‰çš„ä¿å­˜æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬
            document.addEventListener('click', function(event) {
                if (event.target.classList.contains('save-btn')) {
                    event.preventDefault();
                    
                    const button = event.target;
                    const codeElement = button.closest('.python-code') || button.closest('.result-section');
                    
                    if (codeElement) {
                        const codeContent = codeElement.querySelector('.python-content');
                        const headerElement = codeElement.querySelector('.python-header span') || 
                                            codeElement.querySelector('.result-header span');
                        
                        const context = headerElement ? 
                            headerElement.textContent.replace(/ğŸ|âœ…|âŒ|ğŸ“„/g, '').trim() : 
                            'éªŒè¯ç»“æœ';
                        
                        if (codeContent) {
                            const code = codeContent.textContent;
                            savePythonCode(code, context);
                        }
                    }
                }
            });
        }

        // åœ¨éªŒè¯å®Œæˆåè‡ªåŠ¨ä¿å­˜
        function autoSaveOnCompletion() {
            if (document.getElementById('auto-save').checked) {
                console.log('è‡ªåŠ¨ä¿å­˜å·²å¯ç”¨ï¼Œå¼€å§‹ä¿å­˜æ–‡ä»¶...');
                
                setTimeout(() => {
                    saveAllFiles();
                }, 1000); // å»¶è¿Ÿ1ç§’ç¡®ä¿æ‰€æœ‰ç»“æœéƒ½å·²ç”Ÿæˆ
            }
        }

        // ç»“æœå±•ç¤ºå‡½æ•°
        function showVerificationResult(stepNumber, title, content, status = 'completed', isPython = false) {
            const container = document.getElementById('results-container');
            
            const processedContent = processMathFormulas(content);
            
            const resultSection = document.createElement('div');
            resultSection.className = `result-section ${status}${isPython ? ' python' : ''}`;
            
            const icon = isPython ? 'ğŸ' : 
                       status === 'completed' ? 'âœ…' : 
                       status === 'failed' ? 'âŒ' : 'ğŸ”„';
            
            resultSection.innerHTML = `
                <div class="result-header">
                    <span>${icon} ${stepNumber ? `æ­¥éª¤${stepNumber}: ` : ''}${title}</span>
                    ${isPython ? '<button class="save-btn" onclick="savePythonResult(this)">ğŸ’¾ ä¿å­˜</button>' : ''}
                </div>
                <div class="result-content math-content">${processedContent}</div>
            `;
            
            container.appendChild(resultSection);
            renderMathInElement(resultSection);
            resultSection.scrollIntoView({ behavior: 'smooth' });
            
            return resultSection;
        }

        function showPythonExecution(code, output, context = '', hasImage = false, imageData = null) {
            const container = document.getElementById('results-container');
            
            const pythonSection = document.createElement('div');
            pythonSection.className = 'python-code';
            pythonSection.innerHTML = `
                <div class="python-header">
                    <span>ğŸ PythonéªŒè¯ä»£ç ${context ? ` - ${context}` : ''}</span>
                    <button class="save-btn" onclick="savePythonCodeFromElement(this, '${context}')">
                        ğŸ’¾ ä¿å­˜ä»£ç 
                    </button>
                </div>
                <div class="python-content">${code}</div>
            `;
            
            container.appendChild(pythonSection);
            
            if (output) {
                const processedOutput = processMathFormulas(output);
                
                const outputSection = document.createElement('div');
                outputSection.className = 'python-output output-success';
                outputSection.innerHTML = `
                    <div class="output-header">
                        âœ… æ‰§è¡Œç»“æœ
                    </div>
                    <div class="output-content math-content">${processedOutput}</div>
                `;
                
                container.appendChild(outputSection);
                renderMathInElement(outputSection);
            }
            
            if (hasImage && imageData) {
                const imageSection = document.createElement('div');
                imageSection.className = 'python-output output-success';
                imageSection.innerHTML = `
                    <div class="output-header">
                        ğŸ“Š ç”Ÿæˆçš„å›¾è¡¨
                    </div>
                    <div style="padding: 20px; text-align: center;">
                        <img src="data:image/png;base64,${imageData}" style="max-width: 100%; height: auto; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    </div>
                `;
                
                container.appendChild(imageSection);
            }
        }

        function showErrorReport(errors, severity = 'critical') {
            const container = document.getElementById('results-container');
            
            const errorReport = document.createElement('div');
            errorReport.className = `error-report ${severity}`;
            
            const errorIcon = severity === 'critical' ? 'ğŸš¨' : 'âš ï¸';
            const errorTitle = severity === 'critical' ? 'ä¸¥é‡é”™è¯¯' : 'è­¦å‘Š';
            
            errorReport.innerHTML = `
                <div class="error-header">
                    <div class="error-icon ${severity}">${errorIcon}</div>
                    <span>${errorTitle}æŠ¥å‘Š</span>
                </div>
                <div class="error-details">
                    ${Array.isArray(errors) ? errors.map(error => `â€¢ ${error}`).join('<br>') : errors}
                </div>
            `;
            
            container.appendChild(errorReport);
            systemState.verificationState.totalErrors += Array.isArray(errors) ? errors.length : 1;
            updateStatusDisplay();
        }

        // ä»å…ƒç´ ä¿å­˜Pythonä»£ç 
        function savePythonCodeFromElement(button, context) {
            const codeElement = button.closest('.python-code');
            if (codeElement) {
                const codeContent = codeElement.querySelector('.python-content');
                if (codeContent) {
                    const code = codeContent.textContent;
                    savePythonCode(code, context || 'éªŒè¯ä»£ç ');
                }
            }
        }

        // PythonéªŒè¯èŠ‚ç‚¹å®ç°
        async function pythonNode1_InitialValidation(solution) {
            updatePythonNodeStatus(1, 'active');
            updateLoadingText('ğŸ PythonèŠ‚ç‚¹1: åˆå§‹å¿«é€ŸéªŒè¯...');
            
            try {
                const validationPrompt = `è¯·ä¸ºä»¥ä¸‹æ•°å­¦è§£ç­”ç”ŸæˆPythonå¿«é€ŸéªŒè¯ä»£ç ï¼š

${solution}

ç”ŸæˆéªŒè¯ä»£ç è¦æ±‚ï¼š
1. éªŒè¯åŸºæœ¬æ•°å­¦è®¡ç®—çš„æ­£ç¡®æ€§
2. æ£€æŸ¥å…³é”®æ•°å€¼ç»“æœ
3. å¿«é€Ÿæ£€æŸ¥å‡½æ•°æ€§è´¨
4. åŸºç¡€è¾¹ç•Œæ¡ä»¶æµ‹è¯•

åªè¾“å‡ºå¯æ‰§è¡Œçš„Pythonä»£ç ï¼Œä¸è¦è§£é‡Šï¼š`;

                const validationCode = await callAI(validationPrompt);
                const pythonCode = extractPythonCode(validationCode);
                
                if (pythonCode) {
                    const result = await executePythonCode(pythonCode, 'åˆå§‹éªŒè¯');
                    if (result.success) {
                        showPythonExecution(pythonCode, result.result, 'åˆå§‹å¿«é€ŸéªŒè¯');
                        updatePythonNodeStatus(1, 'completed');
                    } else {
                        showPythonExecution(pythonCode, `æ‰§è¡Œé”™è¯¯: ${result.error}`, 'åˆå§‹å¿«é€ŸéªŒè¯(å¤±è´¥)');
                        updatePythonNodeStatus(1, 'failed');
                    }
                    return result;
                } else {
                    updatePythonNodeStatus(1, 'failed');
                    return { success: false, error: 'æœªæ‰¾åˆ°Pythonä»£ç ', context: 'åˆå§‹å¿«é€ŸéªŒè¯' };
                }
            } catch (error) {
                updatePythonNodeStatus(1, 'failed');
                return { success: false, error: error.message, context: 'åˆå§‹å¿«é€ŸéªŒè¯' };
            }
        }

        async function pythonNode2_PreVerification(solution) {
            updatePythonNodeStatus(2, 'active');
            updateLoadingText('ğŸ” PythonèŠ‚ç‚¹2: æ•°å­¦æ¨ç†é¢„éªŒè¯...');
            
            try {
                const preVerifyPrompt = `ç”ŸæˆPythonä»£ç éªŒè¯ä»¥ä¸‹æ•°å­¦æ¨ç†çš„å…³é”®æ­¥éª¤ï¼š

${solution}

éªŒè¯é‡ç‚¹ï¼š
1. ä»£æ•°å˜æ¢çš„æ­£ç¡®æ€§
2. å‡½æ•°æ€§è´¨çš„æ•°å€¼éªŒè¯
3. æå€¼ç‚¹å’Œé›¶ç‚¹çš„å‡†ç¡®æ€§
4. ç§¯åˆ†/å¯¼æ•°è®¡ç®—éªŒè¯
5. æ–¹ç¨‹è§£çš„å­˜åœ¨æ€§æ£€æŸ¥

ç”Ÿæˆå®Œæ•´çš„æ•°å­¦éªŒè¯Pythonä»£ç ï¼š`;

                const verificationCode = await callAI(preVerifyPrompt);
                const pythonCode = extractPythonCode(verificationCode);
                
                if (pythonCode) {
                    const result = await executePythonCode(pythonCode, 'é¢„éªŒè¯');
                    if (result.success) {
                        showPythonExecution(pythonCode, result.result, 'æ•°å­¦æ¨ç†é¢„éªŒè¯');
                        updatePythonNodeStatus(2, 'completed');
                    } else {
                        showPythonExecution(pythonCode, `æ‰§è¡Œé”™è¯¯: ${result.error}`, 'æ•°å­¦æ¨ç†é¢„éªŒè¯(å¤±è´¥)');
                        updatePythonNodeStatus(2, 'failed');
                    }
                    return result;
                } else {
                    updatePythonNodeStatus(2, 'failed');
                    return { success: false, error: 'æœªæ‰¾åˆ°Pythonä»£ç ', context: 'æ•°å­¦æ¨ç†é¢„éªŒè¯' };
                }
            } catch (error) {
                updatePythonNodeStatus(2, 'failed');
                return { success: false, error: error.message, context: 'æ•°å­¦æ¨ç†é¢„éªŒè¯' };
            }
        }

        async function pythonNode3_CodeExecution(solution) {
            updatePythonNodeStatus(3, 'active');
            updateLoadingText('âš¡ PythonèŠ‚ç‚¹3: ä¸»ä»£ç æ‰§è¡ŒéªŒè¯...');
            
            try {
                const pythonCode = extractPythonCode(solution);
                if (pythonCode) {
                    const result = await executePythonCode(pythonCode, 'ä¸»æ‰§è¡Œ');
                    
                    if (result.success) {
                        let outputText = result.result;
                        let imageData = null;
                        let hasImage = false;

                        if (result.result.includes('[IMAGE_DATA]')) {
                            const parts = result.result.split('[IMAGE_DATA]');
                            outputText = parts[0];
                            const imageParts = parts[1].split('[/IMAGE_DATA]');
                            imageData = imageParts[0];
                            hasImage = true;
                            outputText += imageParts[1] || '';
                        }

                        showPythonExecution(pythonCode, outputText, 'ä¸»ä»£ç æ‰§è¡Œ', hasImage, imageData);
                        updatePythonNodeStatus(3, 'completed');
                    } else {
                        showPythonExecution(pythonCode, `æ‰§è¡Œé”™è¯¯: ${result.error}`, 'ä¸»ä»£ç æ‰§è¡Œ(å¤±è´¥)');
                        updatePythonNodeStatus(3, 'failed');
                    }
                    
                    return result;
                } else {
                    updatePythonNodeStatus(3, 'failed');
                    return { success: false, error: 'è§£ç­”ä¸­æœªæ‰¾åˆ°Pythonä»£ç ', context: 'ä¸»ä»£ç æ‰§è¡Œ' };
                }
            } catch (error) {
                updatePythonNodeStatus(3, 'failed');
                return { success: false, error: error.message, context: 'ä¸»ä»£ç æ‰§è¡Œ' };
            }
        }

        async function pythonNode4_SpecializedValidation(solution) {
            updatePythonNodeStatus(4, 'active');
            updateLoadingText('ğŸ¯ PythonèŠ‚ç‚¹4: ä¸“é¡¹æ•°å­¦éªŒè¯...');
            
            try {
                // æ£€æµ‹æ•°å­¦ç±»å‹
                const mathType = detectMathType(solution);
                const specializationPrompts = {
                    calculus: 'ç”Ÿæˆå¾®ç§¯åˆ†ä¸“é¡¹éªŒè¯ä»£ç ï¼šå¯¼æ•°è®¡ç®—ã€ç§¯åˆ†éªŒè¯ã€æé™åˆ†æã€è¿ç»­æ€§æ£€æŸ¥',
                    algebra: 'ç”Ÿæˆä»£æ•°ä¸“é¡¹éªŒè¯ä»£ç ï¼šæ–¹ç¨‹æ±‚è§£ã€å› å¼åˆ†è§£ã€ä¸ç­‰å¼éªŒè¯ã€å¤šé¡¹å¼æ€§è´¨',
					geometry: 'ç”Ÿæˆå‡ ä½•ä¸“é¡¹éªŒè¯ä»£ç ï¼šå›¾å½¢ç»˜åˆ¶ã€è·ç¦»è®¡ç®—ã€è§’åº¦éªŒè¯ã€é¢ç§¯ä½“ç§¯',
                    analysis: 'ç”Ÿæˆæ•°å­¦åˆ†æä¸“é¡¹éªŒè¯ä»£ç ï¼šå‡½æ•°æ€§è´¨ã€å•è°ƒæ€§ã€å‡¹å‡¸æ€§ã€æ¸è¿‘çº¿',
                    numberTheory: 'ç”Ÿæˆæ•°è®ºä¸“é¡¹éªŒè¯ä»£ç ï¼šç´ æ•°æ£€éªŒã€æ¨¡è¿ç®—ã€æ•°è®ºå‡½æ•°'
                };

                const prompt = `${specializationPrompts[mathType] || specializationPrompts.analysis}ï¼š

${solution}

ç”Ÿæˆä¸“é¡¹éªŒè¯çš„Pythonä»£ç ï¼Œç¡®ä¿æ•°å­¦ç†è®ºä¸è®¡ç®—ç»“æœä¸€è‡´ã€‚`;

                const specialCode = await callAI(prompt);
                const pythonCode = extractPythonCode(specialCode);
                
                if (pythonCode) {
                    const result = await executePythonCode(pythonCode, 'ä¸“é¡¹éªŒè¯');
                    if (result.success) {
                        showPythonExecution(pythonCode, result.result, `${mathType}ä¸“é¡¹éªŒè¯`);
                        updatePythonNodeStatus(4, 'completed');
                    } else {
                        showPythonExecution(pythonCode, `æ‰§è¡Œé”™è¯¯: ${result.error}`, `${mathType}ä¸“é¡¹éªŒè¯(å¤±è´¥)`);
                        updatePythonNodeStatus(4, 'failed');
                    }
                    return result;
                } else {
                    updatePythonNodeStatus(4, 'failed');
                    return { success: false, error: 'æœªæ‰¾åˆ°ä¸“é¡¹éªŒè¯ä»£ç ', context: 'ä¸“é¡¹éªŒè¯' };
                }
            } catch (error) {
                updatePythonNodeStatus(4, 'failed');
                return { success: false, error: error.message, context: 'ä¸“é¡¹éªŒè¯' };
            }
        }

        async function pythonNode5_IncrementalComparison(oldSolution, newSolution, iterationNumber) {
            updatePythonNodeStatus(5, 'active');
            updateLoadingText('ğŸ“Š PythonèŠ‚ç‚¹5: å¢é‡å¯¹æ¯”éªŒè¯...');
            
            try {
                const comparePrompt = `ç”ŸæˆPythonä»£ç æ¯”è¾ƒä¸¤ä¸ªè§£ç­”ç‰ˆæœ¬çš„å·®å¼‚å’Œæ”¹è¿›æ•ˆæœï¼š

### ç¬¬${iterationNumber-1}ç‰ˆè§£ç­” ###
${oldSolution}

### ç¬¬${iterationNumber}ç‰ˆè§£ç­” ###
${newSolution}

ç”Ÿæˆå¯¹æ¯”éªŒè¯ä»£ç ï¼š
1. è®¡ç®—ç»“æœçš„å˜åŒ–åˆ†æ
2. ç²¾åº¦æå‡æƒ…å†µè¯„ä¼°
3. æ–°å¢éªŒè¯çš„æœ‰æ•ˆæ€§
4. æ€§èƒ½å’Œå‡†ç¡®æ€§å¯¹æ¯”
5. æ”¹è¿›æ•ˆæœé‡åŒ–

è¾“å‡ºå®Œæ•´å¯¹æ¯”éªŒè¯ä»£ç ï¼š`;

                const compareCode = await callAI(comparePrompt);
                const pythonCode = extractPythonCode(compareCode);
                
                if (pythonCode) {
                    const result = await executePythonCode(pythonCode, 'å¢é‡å¯¹æ¯”');
                    if (result.success) {
                        showPythonExecution(pythonCode, result.result, `ç¬¬${iterationNumber}è½®å¢é‡å¯¹æ¯”`);
                        updatePythonNodeStatus(5, 'completed');
                    } else {
                        showPythonExecution(pythonCode, `æ‰§è¡Œé”™è¯¯: ${result.error}`, `ç¬¬${iterationNumber}è½®å¢é‡å¯¹æ¯”(å¤±è´¥)`);
                        updatePythonNodeStatus(5, 'failed');
                    }
                    return result;
                } else {
                    updatePythonNodeStatus(5, 'failed');
                    return { success: false, error: 'æœªæ‰¾åˆ°å¯¹æ¯”ä»£ç ', context: 'å¢é‡å¯¹æ¯”' };
                }
            } catch (error) {
                updatePythonNodeStatus(5, 'failed');
                return { success: false, error: error.message, context: 'å¢é‡å¯¹æ¯”' };
            }
        }

        async function pythonNode6_ErrorDetectionFix(solution, errorReports) {
            updatePythonNodeStatus(6, 'active');
            updateLoadingText('ğŸ”§ PythonèŠ‚ç‚¹6: é”™è¯¯æ£€æµ‹ä¿®å¤...');
            
            try {
                if (errorReports && errorReports.length > 0) {
                    const fixPrompt = `åŸºäºå‘ç°çš„é”™è¯¯ç”Ÿæˆè¯Šæ–­å’Œä¿®å¤ä»£ç ï¼š

### å½“å‰è§£ç­” ###
${solution}

### å‘ç°çš„é”™è¯¯ ###
${errorReports.join('\n')}

ç”ŸæˆPythonä»£ç ï¼š
1. é‡ç°å’Œè¯Šæ–­è¿™äº›é”™è¯¯
2. æä¾›æ­£ç¡®çš„è®¡ç®—æ–¹æ³•
3. å¯¹æ¯”é”™è¯¯å’Œæ­£ç¡®ç»“æœ
4. ç»™å‡ºå…·ä½“ä¿®å¤å»ºè®®
5. éªŒè¯ä¿®å¤åçš„æ­£ç¡®æ€§

è¾“å‡ºè¯Šæ–­ä¿®å¤ä»£ç ï¼š`;

                    const fixCode = await callAI(fixPrompt);
                    const pythonCode = extractPythonCode(fixCode);
                    
                    if (pythonCode) {
                        const result = await executePythonCode(pythonCode, 'é”™è¯¯ä¿®å¤');
                        if (result.success) {
                            showPythonExecution(pythonCode, result.result, 'é”™è¯¯æ£€æµ‹ä¿®å¤');
                            updatePythonNodeStatus(6, 'completed');
                        } else {
                            showPythonExecution(pythonCode, `æ‰§è¡Œé”™è¯¯: ${result.error}`, 'é”™è¯¯æ£€æµ‹ä¿®å¤(å¤±è´¥)');
                            updatePythonNodeStatus(6, 'failed');
                        }
                        return result;
                    } else {
                        updatePythonNodeStatus(6, 'failed');
                        return { success: false, error: 'æœªæ‰¾åˆ°ä¿®å¤ä»£ç ', context: 'é”™è¯¯æ£€æµ‹ä¿®å¤' };
                    }
                } else {
                    updatePythonNodeStatus(6, 'completed');
                    return { success: true, result: 'æ— é”™è¯¯éœ€è¦ä¿®å¤', context: 'é”™è¯¯æ£€æµ‹ä¿®å¤' };
                }
            } catch (error) {
                updatePythonNodeStatus(6, 'failed');
                return { success: false, error: error.message, context: 'é”™è¯¯æ£€æµ‹ä¿®å¤' };
            }
        }

        async function pythonNode7_CrossValidation(solution, allPythonResults) {
            updatePythonNodeStatus(7, 'active');
            updateLoadingText('âœ… PythonèŠ‚ç‚¹7: äº¤å‰éªŒè¯ç¡®è®¤...');
            
            try {
                const crossValidationPrompt = `åŸºäºæ‰€æœ‰PythonéªŒè¯ç»“æœè¿›è¡Œäº¤å‰éªŒè¯ï¼š

### æ•°å­¦è§£ç­” ###
${solution}

### æ‰€æœ‰PythonéªŒè¯ç»“æœæ±‡æ€» ###
${allPythonResults.map((result, index) => `èŠ‚ç‚¹${index+1}: ${result.success ? result.result : result.error}`).join('\n\n')}

ç”Ÿæˆäº¤å‰éªŒè¯Pythonä»£ç ï¼š
1. éªŒè¯å„èŠ‚ç‚¹ç»“æœçš„ä¸€è‡´æ€§
2. æ£€æŸ¥æ•°å­¦æ¨ç†ä¸è®¡ç®—çš„åŒ¹é…åº¦
3. è¯„ä¼°æ•´ä½“éªŒè¯å¯é æ€§
4. è®¡ç®—æœ€ç»ˆç½®ä¿¡åº¦
5. ç”Ÿæˆç»¼åˆéªŒè¯æŠ¥å‘Š

è¾“å‡ºäº¤å‰éªŒè¯ä»£ç ï¼š`;

                const crossCode = await callAI(crossValidationPrompt);
                const pythonCode = extractPythonCode(crossCode);
                
                if (pythonCode) {
                    const result = await executePythonCode(pythonCode, 'äº¤å‰éªŒè¯');
                    if (result.success) {
                        showPythonExecution(pythonCode, result.result, 'äº¤å‰éªŒè¯ç¡®è®¤');
                        updatePythonNodeStatus(7, 'completed');
                        
                        // å°è¯•ä»ç»“æœä¸­æå–ç½®ä¿¡åº¦
                        const confidenceMatch = result.result.match(/ç½®ä¿¡åº¦[ï¼š:]\s*(\d+(?:\.\d+)?)/);
                        if (confidenceMatch) {
                            const extractedConfidence = Math.round(parseFloat(confidenceMatch[1]));
                            // åªæœ‰åœ¨åˆç†èŒƒå›´å†…æ‰ä½¿ç”¨æå–çš„ç½®ä¿¡åº¦
                            if (extractedConfidence >= 0 && extractedConfidence <= 100) {
                                systemState.verificationState.confidence = extractedConfidence;
                                updateStatusDisplay();
                            }
                        }
                    } else {
                        showPythonExecution(pythonCode, `æ‰§è¡Œé”™è¯¯: ${result.error}`, 'äº¤å‰éªŒè¯ç¡®è®¤(å¤±è´¥)');
                        updatePythonNodeStatus(7, 'failed');
                    }
                    return result;
                } else {
                    updatePythonNodeStatus(7, 'failed');
                    return { success: false, error: 'æœªæ‰¾åˆ°äº¤å‰éªŒè¯ä»£ç ', context: 'äº¤å‰éªŒè¯ç¡®è®¤' };
                }
            } catch (error) {
                updatePythonNodeStatus(7, 'failed');
                return { success: false, error: error.message, context: 'äº¤å‰éªŒè¯ç¡®è®¤' };
            }
        }

        // è¾…åŠ©å‡½æ•°
        function detectMathType(text) {
            if (text.includes('å¯¼æ•°') || text.includes('ç§¯åˆ†') || text.includes('å¾®åˆ†') || text.includes('æé™')) {
                return 'calculus';
            } else if (text.includes('æ–¹ç¨‹') || text.includes('å¤šé¡¹å¼') || text.includes('ä»£æ•°')) {
                return 'algebra';
            } else if (text.includes('å‡ ä½•') || text.includes('è·ç¦»') || text.includes('è§’åº¦')) {
                return 'geometry';
            } else if (text.includes('å‡½æ•°') || text.includes('å•è°ƒ') || text.includes('æå€¼') || text.includes('é›¶ç‚¹')) {
                return 'analysis';
            } else if (text.includes('ç´ æ•°') || text.includes('æ¨¡è¿ç®—') || text.includes('æ•°è®º')) {
                return 'numberTheory';
            } else {
                return 'analysis'; // é»˜è®¤
            }
        }

        function extractErrors(verificationResult) {
            const errorPatterns = [
                /é”™è¯¯[ï¼š:](.+?)(?=\n|$)/g,
                /é—®é¢˜[ï¼š:](.+?)(?=\n|$)/g,
                /ç¼ºé™·[ï¼š:](.+?)(?=\n|$)/g,
                /ä¸¥é‡é”™è¯¯[ï¼š:](.+?)(?=\n|$)/g
            ];
            
            const errors = [];
            errorPatterns.forEach(pattern => {
                let match;
                while ((match = pattern.exec(verificationResult)) !== null) {
                    errors.push(match[1].trim());
                }
            });
            
            return errors;
        }

        // è·å–ä¸¥æ ¼éªŒè¯æç¤ºè¯
        function getRigorousVerificationPrompt(problem) {
            const rigor = document.getElementById('verification-rigor').value;
            
            const rigorLevels = {
                strict: {
                    emphasis: "æå…¶ä¸¥æ ¼",
                    requirements: `
- æ¯ä¸€ä¸ªæ•°å­¦æ¨å¯¼æ­¥éª¤éƒ½å¿…é¡»æœ‰ä¸¥æ ¼çš„é€»è¾‘ä¾æ®
- ä»»ä½•æ•°å€¼è®¡ç®—éƒ½å¿…é¡»ç»™å‡ºç²¾ç¡®å€¼å’Œè¿‘ä¼¼å€¼
- å¿…é¡»è€ƒè™‘æ‰€æœ‰è¾¹ç•Œæ¡ä»¶å’Œç‰¹æ®Šæƒ…å†µ
- è¯æ˜å¿…é¡»å®Œæ•´æ— ç¼ºï¼Œä¸å…è®¸ä»»ä½•é€»è¾‘è·³è·ƒ
- å¿…é¡»æä¾›åä¾‹æ£€éªŒå’ŒéªŒè¯æ–¹æ³•`
                },
                moderate: {
                    emphasis: "é€‚åº¦ä¸¥æ ¼",
                    requirements: `
- ä¸»è¦æ¨å¯¼æ­¥éª¤éœ€è¦æ¸…æ™°çš„é€»è¾‘æ”¯æŒ
- é‡è¦è®¡ç®—éœ€è¦éªŒè¯
- éœ€è¦è€ƒè™‘ä¸»è¦çš„è¾¹ç•Œæ¡ä»¶
- è¯æ˜éœ€è¦åŸºæœ¬å®Œæ•´`
                },
                lenient: {
                    emphasis: "åŸºæœ¬ä¸¥æ ¼",
                    requirements: `
- åŸºæœ¬æ¨å¯¼æ­¥éª¤éœ€è¦åˆç†
- ä¸»è¦ç»“æœéœ€è¦éªŒè¯
- åŸºæœ¬é€»è¾‘éœ€è¦æ¸…æ™°`
                }
            };

            const level = rigorLevels[rigor];

            return `ä½ æ˜¯ä¸€ä½${level.emphasis}çš„æ•°å­¦éªŒè¯ä¸“å®¶ã€‚è¯·å¯¹ä»¥ä¸‹æ•°å­¦é—®é¢˜è¿›è¡Œå®Œæ•´çš„è§£ç­”å’Œä¸¥æ ¼éªŒè¯ï¼š

### é—®é¢˜ ###
${problem}

### éªŒè¯æ ‡å‡† (${level.emphasis}æ¨¡å¼) ###
${level.requirements}

### è§£ç­”è¦æ±‚ ###
1. **æ•°å­¦åˆ†æ**: æ·±å…¥åˆ†æé—®é¢˜çš„æ•°å­¦æœ¬è´¨ï¼Œä½¿ç”¨LaTeXæ ¼å¼è¡¨ç¤ºå…³é”®å…¬å¼
2. **è§£é¢˜æ–¹æ³•**: é€‰æ‹©æœ€é€‚å½“çš„æ•°å­¦æ–¹æ³•ï¼Œè¯´æ˜é€‰æ‹©ç†ç”±
3. **è¯¦ç»†æ¨å¯¼**: æä¾›å®Œæ•´çš„æ•°å­¦æ¨å¯¼è¿‡ç¨‹ï¼Œæ¯æ­¥éƒ½æœ‰æ˜ç¡®ä¾æ®
4. **PythonéªŒè¯**: ç”Ÿæˆå®Œæ•´çš„Pythonä»£ç éªŒè¯æ‰€æœ‰å…³é”®ç»“æœ
5. **ç»“æœæ£€éªŒ**: é€šè¿‡å¤šç§æ–¹æ³•éªŒè¯ç»“æœçš„æ­£ç¡®æ€§
6. **è¾¹ç•Œåˆ†æ**: åˆ†æç‰¹æ®Šæƒ…å†µå’Œè¾¹ç•Œæ¡ä»¶

### Pythonä»£ç è¦æ±‚ ###
- å¯¼å…¥æ‰€æœ‰å¿…è¦çš„æ•°å­¦åº“ (numpy, scipy, sympy, matplotlib)
- å®ç°ç¬¦å·è®¡ç®—å’Œæ•°å€¼è®¡ç®—çš„å¯¹æ¯”
- ç”Ÿæˆå¯è§†åŒ–å›¾è¡¨éªŒè¯ç»“æœ
- åŒ…å«è¯¦ç»†çš„æ³¨é‡Šè¯´æ˜
- æä¾›ç²¾ç¡®å€¼å’Œæ•°å€¼è¿‘ä¼¼çš„å¯¹æ¯”

è¯·ç¡®ä¿è§£ç­”ä¸­å¤§é‡ä½¿ç”¨LaTeXæ ¼å¼çš„æ•°å­¦å…¬å¼ï¼Œä¾¿äºåç»­æ¸²æŸ“å’ŒéªŒè¯ã€‚`;
        }

        function getStrictVerificationPrompt(solution, pythonResults) {
            const pythonSummary = pythonResults
                .filter(result => result && result.success)
                .map((result, index) => `PythonèŠ‚ç‚¹${index+1}: ${result.result || 'æ‰§è¡ŒæˆåŠŸ'}`)
                .join('\n\n');

            return `ä½ æ˜¯ä¸¥æ ¼çš„æ•°å­¦å®¡æŸ¥ä¸“å®¶ã€‚è¯·å¯¹ä»¥ä¸‹è§£ç­”è¿›è¡Œå…¨é¢éªŒè¯å¹¶ç”Ÿæˆè¯¦ç»†çš„é”™è¯¯æŠ¥å‘Šï¼š

### å¾…éªŒè¯è§£ç­” ###
${solution}

### PythonéªŒè¯ç»“æœæ±‡æ€» ###
${pythonSummary || 'æ— PythonéªŒè¯ç»“æœ'}

### éªŒè¯ä»»åŠ¡ ###
è¯·è¿›è¡Œä¸¥æ ¼çš„å¤šç»´åº¦éªŒè¯ï¼š

1. **æ•°å­¦ä¸¥è°¨æ€§éªŒè¯**:
   - æ£€æŸ¥æ¯ä¸ªæ•°å­¦æ¨å¯¼æ­¥éª¤çš„é€»è¾‘æ­£ç¡®æ€§
   - éªŒè¯å…¬å¼åº”ç”¨çš„å‡†ç¡®æ€§
   - ç¡®è®¤å®šç†å’Œå¼•ç†çš„æ­£ç¡®å¼•ç”¨
   - æ£€æŸ¥è¯æ˜çš„å®Œæ•´æ€§

2. **è®¡ç®—æ­£ç¡®æ€§éªŒè¯**:
   - éªŒè¯æ‰€æœ‰æ•°å€¼è®¡ç®—çš„å‡†ç¡®æ€§
   - æ£€æŸ¥Pythonä»£ç ä¸æ•°å­¦æ¨ç†çš„ä¸€è‡´æ€§
   - ç¡®è®¤ç²¾ç¡®å€¼å’Œè¿‘ä¼¼å€¼çš„æ­£ç¡®æ€§
   - éªŒè¯è¾¹ç•Œæ¡ä»¶å’Œç‰¹æ®Šæƒ…å†µ

3. **é€»è¾‘ä¸€è‡´æ€§éªŒè¯**:
   - æ£€æŸ¥æ¨ç†é“¾æ¡çš„å®Œæ•´æ€§
   - éªŒè¯ç»“è®ºä¸å‰æçš„é€»è¾‘å…³ç³»
   - ç¡®è®¤æ²¡æœ‰å¾ªç¯è®ºè¯æˆ–é€»è¾‘è·³è·ƒ
   - æ£€æŸ¥åä¾‹çš„å¤„ç†

4. **æ–¹æ³•é€‚å½“æ€§éªŒè¯**:
   - è¯„ä¼°æ‰€é€‰æ•°å­¦æ–¹æ³•çš„åˆé€‚æ€§
   - æ£€æŸ¥æ˜¯å¦å­˜åœ¨æ›´ä¼˜çš„è§£é¢˜è·¯å¾„
   - éªŒè¯ç®—æ³•çš„æ”¶æ•›æ€§å’Œç¨³å®šæ€§

### é”™è¯¯æŠ¥å‘Šæ ¼å¼ ###
è¯·æŒ‰ä»¥ä¸‹æ ¼å¼ç”Ÿæˆç»“æ„åŒ–çš„é”™è¯¯æŠ¥å‘Šï¼š

**æ€»ä½“è¯„ä¼°**: [é€šè¿‡/éœ€è¦æ”¹è¿›/å­˜åœ¨ä¸¥é‡é—®é¢˜]

**ä¸¥é‡é”™è¯¯** (Critical Errors):
[åˆ—å‡ºæ‰€æœ‰é€»è¾‘é”™è¯¯ã€è®¡ç®—é”™è¯¯ã€è¯æ˜ç¼ºé™·ç­‰ä¸¥é‡é—®é¢˜]

**é€»è¾‘ç¼ºé™·** (Logic Gaps):
[åˆ—å‡ºæ¨ç†ä¸ä¸¥å¯†ã€è¯æ˜ä¸å®Œæ•´ç­‰é€»è¾‘é—®é¢˜]

**è®¡ç®—é—®é¢˜** (Calculation Issues):
[åˆ—å‡ºæ•°å€¼é”™è¯¯ã€ç²¾åº¦é—®é¢˜ã€ä»£ç é”™è¯¯ç­‰è®¡ç®—é—®é¢˜]

**è¡¨è¿°é—®é¢˜** (Presentation Issues):
[åˆ—å‡ºå…¬å¼è¡¨ç¤ºã€ç¬¦å·ä½¿ç”¨ã€è¡¨è¾¾ä¸æ¸…ç­‰è¡¨è¿°é—®é¢˜]

**æ”¹è¿›å»ºè®®** (Improvement Suggestions):
[é’ˆå¯¹æ¯ä¸ªé—®é¢˜æä¾›å…·ä½“çš„æ”¹è¿›å»ºè®®]

**éªŒè¯ç½®ä¿¡åº¦**: [0-100åˆ†]

è¯·æä¾›è¯šå®ã€å®¢è§‚ã€ä¸¥æ ¼çš„è¯„ä¼°ã€‚å¦‚æœå‘ç°é—®é¢˜ï¼Œè¯·ç»™å‡ºå…·ä½“çš„ä½ç½®å’Œæ”¹è¿›æ–¹å‘ã€‚`;
        }

        function getErrorReviewPrompt(errorReport, solution) {
            return `ä½ æ˜¯èµ„æ·±æ•°å­¦å®¡æŸ¥å‘˜ã€‚è¯·ä»”ç»†å®¡æŸ¥ä»¥ä¸‹é”™è¯¯æŠ¥å‘Šçš„å‡†ç¡®æ€§ï¼š

### åŸå§‹è§£ç­” ###
${solution}

### é”™è¯¯æŠ¥å‘Š ###
${errorReport}

### å®¡æŸ¥ä»»åŠ¡ ###
è¯·å¯¹é”™è¯¯æŠ¥å‘Šè¿›è¡Œå®¡æŸ¥ï¼š

1. **éªŒè¯æŠ¥å‘Šå‡†ç¡®æ€§**: æ¯ä¸ªæŒ‡å‡ºçš„é”™è¯¯æ˜¯å¦çœŸçš„æ˜¯é”™è¯¯ï¼Ÿ
2. **æ£€æŸ¥è¯¯æŠ¥**: æ˜¯å¦æœ‰è¢«é”™è¯¯æ ‡è®°ä¸ºé—®é¢˜çš„æ­£ç¡®å†…å®¹ï¼Ÿ
3. **è¡¥å……é—æ¼**: æ˜¯å¦æœ‰çœŸæ­£çš„é”™è¯¯è¢«é—æ¼äº†ï¼Ÿ
4. **è¯„ä¼°ä¸¥é‡æ€§**: é”™è¯¯çš„ä¸¥é‡ç¨‹åº¦åˆ†ç±»æ˜¯å¦åˆé€‚ï¼Ÿ

### å®¡æŸ¥ç»“æœæ ¼å¼ ###
**å®¡æŸ¥ç»“è®º**: [æŠ¥å‘ŠåŸºæœ¬å‡†ç¡®/å­˜åœ¨è¯¯æŠ¥/é—æ¼é‡è¦é—®é¢˜]

**ç¡®è®¤çš„çœŸå®é”™è¯¯**:
[åˆ—å‡ºç»å®¡æŸ¥ç¡®è®¤çš„çœŸå®é”™è¯¯]

**è¯¯æŠ¥çš„é—®é¢˜**:
[åˆ—å‡ºè¢«é”™è¯¯æ ‡è®°ä½†å®é™…æ­£ç¡®çš„å†…å®¹]

**è¡¥å……å‘ç°çš„é”™è¯¯**:
[åˆ—å‡ºåŸæŠ¥å‘Šé—æ¼çš„çœŸå®é”™è¯¯]

**ä¿®æ­£åçš„æ”¹è¿›å»ºè®®**:
[åŸºäºå®¡æŸ¥ç»“æœç»™å‡ºçš„æœ€ç»ˆæ”¹è¿›å»ºè®®]

è¯·ä¿æŒå®¢è§‚å’Œä¸¥è°¨çš„å®¡æŸ¥æ€åº¦ã€‚`;
        }

        function getImprovementPrompt(solution, reviewedErrors, pythonResults) {
            const validPythonResults = pythonResults
                .filter(result => result && result.success)
                .map((result, index) => `PythonéªŒè¯${index+1}: ${result.result}`)
                .join('\n\n');

            return `è¯·åŸºäºé”™è¯¯æŠ¥å‘Šå’ŒPythonéªŒè¯ç»“æœæ”¹è¿›ä»¥ä¸‹æ•°å­¦è§£ç­”ï¼š

### åŸå§‹è§£ç­” ###
${solution}

### ç»å®¡æŸ¥çš„é”™è¯¯å’Œæ”¹è¿›å»ºè®® ###
${reviewedErrors}

### PythonéªŒè¯ç»“æœå‚è€ƒ ###
${validPythonResults}

### æ”¹è¿›è¦æ±‚ ###
1. **ä¿®æ­£æ‰€æœ‰ç¡®è®¤çš„é”™è¯¯**
2. **è¡¥å……ä¸å®Œæ•´çš„è¯æ˜**
3. **æ”¹è¿›è®¡ç®—ç²¾åº¦å’Œæ–¹æ³•**
4. **ä¼˜åŒ–Pythonä»£ç å®ç°**
5. **å¢å¼ºæ•°å­¦è¡¨è¾¾çš„ä¸¥è°¨æ€§**
6. **ç¡®ä¿ç†è®ºä¸è®¡ç®—ä¸€è‡´**

### æ”¹è¿›è¾“å‡ºè¦æ±‚ ###
- ä¿æŒåŸæœ‰çš„æ­£ç¡®éƒ¨åˆ†
- æ˜ç¡®æ ‡æ³¨æ”¹è¿›çš„éƒ¨åˆ†
- ä½¿ç”¨LaTeXæ ¼å¼è¡¨ç¤ºæ•°å­¦å…¬å¼
- æä¾›å®Œæ•´å¯æ‰§è¡Œçš„Pythonä»£ç 
- åŒ…å«å……åˆ†çš„éªŒè¯å’Œæ£€éªŒ

è¯·æä¾›å®Œæ•´çš„æ”¹è¿›ç‰ˆè§£ç­”ï¼Œç¡®ä¿æ•°å­¦ä¸¥è°¨æ€§å’Œè®¡ç®—å‡†ç¡®æ€§ã€‚`;
        }

        // æµ‹è¯•AIè¿æ¥
        async function testAIConnection() {
            const testBtn = document.getElementById('test-btn');
            const statusIndicator = document.getElementById('connection-status');
            
            const provider = document.getElementById('api-provider').value;
            const apiKey = document.getElementById('api-key').value.trim();
            const model = document.getElementById('model-version').value;
            
            if (!apiKey) {
                showNotification('è¯·è¾“å…¥APIå¯†é’¥', 'error');
                return;
            }

            testBtn.disabled = true;
            testBtn.textContent = 'ğŸ”„ æµ‹è¯•ä¸­...';
            statusIndicator.className = 'status-indicator status-testing';

            try {
                const config = apiEndpoints[provider];
                let url = config.url;
                let headers = {};
                let body = {};

                if (provider === 'gemini') {
                    url = url.replace('{model}', model).replace('{apiKey}', apiKey);
                    headers = config.headers();
                    body = config.formatRequest([{ content: 'æµ‹è¯•è¿æ¥ï¼Œè¯·å›å¤"è¿æ¥æˆåŠŸ"' }], model);
                } else {
                    headers = config.headers(apiKey);
                    body = config.formatRequest([{ role: "user", content: "æµ‹è¯•è¿æ¥ï¼Œè¯·å›å¤'è¿æ¥æˆåŠŸ'" }], model);
                }

                const response = await fetch(url, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(body)
                });

                if (response.ok) {
                    statusIndicator.className = 'status-indicator status-connected';
                    systemState.aiConfig = {
                        provider,
                        apiKey,
                        model,
                        isConnected: true
                    };
                    testBtn.textContent = 'âœ… è¿æ¥æˆåŠŸ';
                    showNotification(`${provider.toUpperCase()} APIè¿æ¥æˆåŠŸ`, 'success');
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                statusIndicator.className = 'status-indicator status-disconnected';
                testBtn.textContent = 'âŒ è¿æ¥å¤±è´¥';
                showNotification(`è¿æ¥å¤±è´¥: ${error.message}`, 'error');
            } finally {
                testBtn.disabled = false;
                setTimeout(() => {
                    testBtn.textContent = 'ğŸ”— æµ‹è¯•è¿æ¥';
                }, 3000);
            }
        }

        // æ›´æ–°æ¨¡å‹é€‰é¡¹
        function updateModelOptions() {
            const provider = document.getElementById('api-provider').value;
            const modelSelect = document.getElementById('model-version');
            
            modelSelect.innerHTML = '';
            
            const models = {
                deepseek: [
                    { value: 'deepseek-chat', text: 'DeepSeek Chat' },
                    { value: 'deepseek-coder', text: 'DeepSeek Coder' }
                ],
                gemini: [
                    { value: 'gemini-2.0-flash-exp', text: 'Gemini 2.0 Flash (å®éªŒç‰ˆ)' },
                    { value: 'gemini-1.5-pro', text: 'Gemini 1.5 Pro' },
                    { value: 'gemini-1.5-flash', text: 'Gemini 1.5 Flash' }
                ],
                openai: [
                    { value: 'gpt-4', text: 'GPT-4' },
                    { value: 'gpt-4-turbo', text: 'GPT-4 Turbo' },
                    { value: 'gpt-3.5-turbo', text: 'GPT-3.5 Turbo' }
                ]
            };

            models[provider].forEach(model => {
                const option = document.createElement('option');
                option.value = model.value;
                option.textContent = model.text;
                modelSelect.appendChild(option);
            });
        }

        // ä¸»éªŒè¯æµç¨‹
        async function startRigorousVerification() {
            if (!systemState.aiConfig.isConnected) {
                showNotification('è¯·å…ˆé…ç½®å¹¶æµ‹è¯•AIè¿æ¥', 'error');
                return;
            }

            if (!systemState.pyodide) {
                showNotification('Pythonç¯å¢ƒæœªåˆå§‹åŒ–ï¼Œè¯·ç­‰å¾…åŠ è½½å®Œæˆ', 'error');
                return;
            }

            const problem = document.getElementById('problem-input').value.trim();
            if (!problem) {
                showNotification('è¯·è¾“å…¥æ•°å­¦é—®é¢˜', 'error');
                return;
            }

            // åˆå§‹åŒ–éªŒè¯çŠ¶æ€
            systemState.verificationState = {
                currentStep: 0,
                currentIteration: 0,
                maxIterations: parseInt(document.getElementById('max-iterations').value),
                consecutivePasses: 0,
                requiredPasses: parseInt(document.getElementById('consecutive-passes-config').value),
                totalErrors: 0,
                pythonValidations: 0,
                pythonFailures: 0,
                syntaxErrors: 0,
                verificationScore: 0,
                confidence: 0,
                isRunning: true
            };

            systemState.solutions = [];
            systemState.errorReports = [];
            systemState.pythonResults = [];
            systemState.savedFiles = [];

            const solveButton = document.getElementById('solve-button');
            solveButton.disabled = true;
            solveButton.textContent = 'ğŸ”¬ ä¸¥æ ¼éªŒè¯è¿›è¡Œä¸­...';

            const resultsContainer = document.getElementById('results-container');
            resultsContainer.innerHTML = '';

            document.getElementById('loading').classList.add('show');
            showIterationTracker();

            try {
                // é‡ç½®æ‰€æœ‰çŠ¶æ€
                for (let i = 1; i <= 6; i++) {
                    updateMainStepStatus(i, '');
                }
                for (let i = 1; i <= 7; i++) {
                    updatePythonNodeStatus(i, '');
                }
                updateStatusDisplay();

                let currentSolution = null;
                let iterationCount = 0;
                let previousSolution = null;
                let lastVerificationResult = '';

                while (iterationCount < systemState.verificationState.maxIterations && 
                       systemState.verificationState.consecutivePasses < systemState.verificationState.requiredPasses) {
                    
                    iterationCount++;
                    systemState.verificationState.currentIteration = iterationCount;
                    updateStatusDisplay();
                    
                    console.log(`å¼€å§‹ç¬¬${iterationCount}è½®ä¸¥æ ¼éªŒè¯`);

                    // é‡ç½®PythonèŠ‚ç‚¹çŠ¶æ€
                    for (let i = 1; i <= 7; i++) {
                        updatePythonNodeStatus(i, '');
                    }

                    let pythonResults = [];

                    // æ­¥éª¤1: åˆå§‹è§£ç”Ÿæˆ (ä»…ç¬¬ä¸€æ¬¡è¿­ä»£)
                    if (iterationCount === 1) {
                        updateMainStepStatus(1, 'active');
                        updateLoadingText('ğŸ” æ­¥éª¤1: ç”Ÿæˆä¸¥æ ¼çš„æ•°å­¦è§£ç­”...');

                        const step1Prompt = getRigorousVerificationPrompt(problem);
                        currentSolution = await callAI(step1Prompt);
                        systemState.solutions.push(currentSolution);
                        
                        updateMainStepStatus(1, 'completed');
                        showVerificationResult(1, 'åˆå§‹è§£ç”Ÿæˆ', currentSolution);

                        // PythonèŠ‚ç‚¹1: åˆå§‹å¿«é€ŸéªŒè¯
                        if (document.getElementById('enable-python-validation').checked) {
                            const pythonResult1 = await pythonNode1_InitialValidation(currentSolution);
                            pythonResults.push(pythonResult1);
                        }
                    }

                    // æ­¥éª¤2: è‡ªæˆ‘æ”¹è¿› (ä»ç¬¬äºŒæ¬¡è¿­ä»£å¼€å§‹)
                    if (iterationCount > 1) {
                        updateMainStepStatus(2, 'active');
                        updateLoadingText('ğŸ”„ æ­¥éª¤2: åŸºäºéªŒè¯ç»“æœæ”¹è¿›è§£ç­”...');

                        // PythonèŠ‚ç‚¹5: å¢é‡å¯¹æ¯”éªŒè¯
                        if (document.getElementById('enable-python-validation').checked && previousSolution) {
                            const pythonResult5 = await pythonNode5_IncrementalComparison(previousSolution, currentSolution, iterationCount);
                            pythonResults.push(pythonResult5);
                        }

                        const lastErrorReport = systemState.errorReports[systemState.errorReports.length - 1];
                        const step2Prompt = getImprovementPrompt(currentSolution, lastErrorReport, pythonResults);
                        currentSolution = await callAI(step2Prompt);
                        systemState.solutions.push(currentSolution);

                        updateMainStepStatus(2, 'completed');
                        showVerificationResult(2, 'è‡ªæˆ‘æ”¹è¿›', currentSolution);
                    }

                    // PythonèŠ‚ç‚¹2: æ•°å­¦æ¨ç†é¢„éªŒè¯
                    if (document.getElementById('enable-python-validation').checked) {
                        const pythonResult2 = await pythonNode2_PreVerification(currentSolution);
                        pythonResults.push(pythonResult2);
                    }

                    // PythonèŠ‚ç‚¹3: ä¸»ä»£ç æ‰§è¡ŒéªŒè¯
                    if (document.getElementById('enable-python-validation').checked) {
                        const pythonResult3 = await pythonNode3_CodeExecution(currentSolution);
                        pythonResults.push(pythonResult3);
                    }

                    // PythonèŠ‚ç‚¹4: ä¸“é¡¹æ•°å­¦éªŒè¯
                    if (document.getElementById('enable-python-validation').checked && 
                        document.getElementById('enable-specialized-math').checked) {
                        const pythonResult4 = await pythonNode4_SpecializedValidation(currentSolution);
                        pythonResults.push(pythonResult4);
                    }

                    // æ­¥éª¤3: ä¸¥æ ¼éªŒè¯ä¸é”™è¯¯æŠ¥å‘Šç”Ÿæˆ
                    updateMainStepStatus(3, 'active');
                    updateLoadingText('ğŸ”¬ æ­¥éª¤3: ä¸¥æ ¼éªŒè¯å¹¶ç”Ÿæˆé”™è¯¯æŠ¥å‘Š...');

                    const step3Prompt = getStrictVerificationPrompt(currentSolution, pythonResults);
                    const verificationResult = await callAI(step3Prompt);
                    lastVerificationResult = verificationResult;
                    
                    updateMainStepStatus(3, 'completed');
                    showVerificationResult(3, 'ä¸¥æ ¼éªŒè¯ä¸é”™è¯¯æŠ¥å‘Š', verificationResult);

                    // æå–é”™è¯¯
                    const errors = extractErrors(verificationResult);
                    if (errors.length > 0) {
                        showErrorReport(errors, 'critical');
                    }

                    // æ­¥éª¤4: é”™è¯¯æŠ¥å‘Šå®¡æŸ¥
                    updateMainStepStatus(4, 'active');
                    updateLoadingText('ğŸ” æ­¥éª¤4: å®¡æŸ¥é”™è¯¯æŠ¥å‘Šå‡†ç¡®æ€§...');

                    const step4Prompt = getErrorReviewPrompt(verificationResult, currentSolution);
                    const reviewResult = await callAI(step4Prompt);
                    systemState.errorReports.push(reviewResult);

                    updateMainStepStatus(4, 'completed');
                    showVerificationResult(4, 'é”™è¯¯æŠ¥å‘Šå®¡æŸ¥', reviewResult);

                    // PythonèŠ‚ç‚¹6: é”™è¯¯æ£€æµ‹ä¿®å¤
                    if (document.getElementById('enable-python-validation').checked && errors.length > 0) {
                        const pythonResult6 = await pythonNode6_ErrorDetectionFix(currentSolution, errors);
                        pythonResults.push(pythonResult6);
                    }

                    // PythonèŠ‚ç‚¹7: äº¤å‰éªŒè¯ç¡®è®¤
                    if (document.getElementById('enable-python-validation').checked) {
                        const pythonResult7 = await pythonNode7_CrossValidation(currentSolution, pythonResults);
                        pythonResults.push(pythonResult7);
                    }

                    systemState.pythonResults.push(pythonResults);

                    // è®¡ç®—éªŒè¯å¾—åˆ†å’Œç½®ä¿¡åº¦
                    const errorAnalysis = analyzeErrors(systemState.errorReports);
                    const verificationScore = calculateVerificationScore(
                        verificationResult,
                        errors,
                        pythonResults,
                        systemState.errorReports
                    );
                    
                    const confidence = calculateConfidence(
                        verificationScore,
                        pythonResults,
                        systemState.errorReports,
                        iterationCount
                    );
                    
                    systemState.verificationState.verificationScore = verificationScore;
                    systemState.verificationState.confidence = confidence;
                    updateStatusDisplay();

                    // æ£€æŸ¥éªŒè¯ç»“æœ
                    const passCheck = checkVerificationPassed(
                        verificationResult,
                        pythonResults,
                        errorAnalysis,
                        verificationScore
                    );

                    if (passCheck.passed) {
                        systemState.verificationState.consecutivePasses++;
                        console.log(`éªŒè¯é€šè¿‡ï¼Œè¿ç»­é€šè¿‡æ¬¡æ•°: ${systemState.verificationState.consecutivePasses}`);
                    } else {
                        systemState.verificationState.consecutivePasses = 0;
                        console.log('éªŒè¯æœªé€šè¿‡ï¼Œæœªæ»¡è¶³æ¡ä»¶:', passCheck.failedConditions);
                    }

                    // æ­¥éª¤5: ä¿®æ­£ä¸ä¼˜åŒ–
                    updateMainStepStatus(5, 'active');
                    updateLoadingText('ğŸ”§ æ­¥éª¤5: åŸºäºæŠ¥å‘Šä¿®æ­£è§£ç­”...');

                    if (systemState.verificationState.consecutivePasses < systemState.verificationState.requiredPasses) {
                        // éœ€è¦ç»§ç»­æ”¹è¿›
                        updateMainStepStatus(5, 'completed');
                        const failedConditionsText = passCheck.failedConditions.length > 0 
                            ? `\næœªæ»¡è¶³æ¡ä»¶: ${passCheck.failedConditions.join(', ')}` 
                            : '';
                        
                        showVerificationResult(5, 'ä¿®æ­£ä¸ä¼˜åŒ–', `ğŸ”„ ç¬¬${iterationCount}è½®éªŒè¯å®Œæˆï¼Œå‘ç°${errors.length}ä¸ªé—®é¢˜ï¼Œç»§ç»­ä¼˜åŒ–...\n\nè¿ç»­é€šè¿‡æ¬¡æ•°: ${systemState.verificationState.consecutivePasses}/${systemState.verificationState.requiredPasses}\néªŒè¯å¾—åˆ†: ${systemState.verificationState.verificationScore}/100\nç½®ä¿¡åº¦: ${systemState.verificationState.confidence}%${failedConditionsText}\n\nå°†åŸºäºé”™è¯¯æŠ¥å‘Šè¿›è¡Œè¿›ä¸€æ­¥æ”¹è¿›ã€‚`);
                    } else {
                        // éªŒè¯é€šè¿‡
                        updateMainStepStatus(5, 'completed');
                        showVerificationResult(5, 'ä¿®æ­£ä¸ä¼˜åŒ–', `âœ… è§£ç­”ç»è¿‡${iterationCount}è½®ä¸¥æ ¼éªŒè¯åè¢«æ¥å—ï¼\n\néªŒè¯å¾—åˆ†: ${systemState.verificationState.verificationScore}/100\nè¿ç»­é€šè¿‡: ${systemState.verificationState.consecutivePasses}æ¬¡\nç½®ä¿¡åº¦: ${systemState.verificationState.confidence}%\nPythonéªŒè¯: ${systemState.verificationState.pythonValidations}æ¬¡`);
                    }

                    // æ­¥éª¤6: æœ€ç»ˆå†³ç­–
                    updateMainStepStatus(6, 'active');
                    updateLoadingText('ğŸ¯ æ­¥éª¤6: æœ€ç»ˆéªŒè¯å†³ç­–...');

                    if (systemState.verificationState.consecutivePasses >= systemState.verificationState.requiredPasses) {
                        updateMainStepStatus(6, 'completed');
                        showVerificationResult(6, 'æœ€ç»ˆå†³ç­–', `âœ… è§£ç­”é€šè¿‡ä¸¥æ ¼éªŒè¯æ ‡å‡†ï¼Œè¢«æ­£å¼æ¥å—ï¼\n\nğŸ“Š éªŒè¯ç»Ÿè®¡:\n- æ€»è¿­ä»£è½®æ•°: ${iterationCount}\n- è¿ç»­éªŒè¯é€šè¿‡: ${systemState.verificationState.consecutivePasses}æ¬¡\n- PythonéªŒè¯æ¬¡æ•°: ${systemState.verificationState.pythonValidations}\n- Pythonå¤±è´¥æ¬¡æ•°: ${systemState.verificationState.pythonFailures}\n- æœ€ç»ˆéªŒè¯å¾—åˆ†: ${systemState.verificationState.verificationScore}/100\n- ç½®ä¿¡åº¦: ${systemState.verificationState.confidence}%\n- å·²ä¿å­˜æ–‡ä»¶: ${systemState.savedFiles.length}ä¸ª\n- AIæä¾›å•†: ${systemState.aiConfig.provider.toUpperCase()}`);
                        break;
                    } else if (iterationCount >= systemState.verificationState.maxIterations) {
                        updateMainStepStatus(6, 'completed');
                        showVerificationResult(6, 'æœ€ç»ˆå†³ç­–', `âš ï¸ å·²è¾¾åˆ°æœ€å¤§è¿­ä»£æ¬¡æ•°(${systemState.verificationState.maxIterations})ï¼Œä½¿ç”¨å½“å‰æœ€ä½³è§£ç­”ã€‚\n\nå»ºè®®ï¼šå¢åŠ è¿­ä»£æ¬¡æ•°æˆ–è°ƒæ•´éªŒè¯æ ‡å‡†ä»¥è·å¾—æ›´ä¸¥æ ¼çš„éªŒè¯ç»“æœã€‚\n\nğŸ“Š æœ€ç»ˆç»Ÿè®¡:\n- éªŒè¯å¾—åˆ†: ${systemState.verificationState.verificationScore}/100\n- ç½®ä¿¡åº¦: ${systemState.verificationState.confidence}%\n- PythonéªŒè¯: ${systemState.verificationState.pythonValidations}æ¬¡\n- Pythonå¤±è´¥: ${systemState.verificationState.pythonFailures}æ¬¡\n- å·²ä¿å­˜æ–‡ä»¶: ${systemState.savedFiles.length}ä¸ª`);
                        break;
                    } else {
                        updateMainStepStatus(6, 'completed');
                        showVerificationResult(6, 'è¿­ä»£å†³ç­–', `ğŸ”„ ç¬¬${iterationCount}è½®å†³ç­–: ç»§ç»­ä¸¥æ ¼éªŒè¯æµç¨‹\n\nå½“å‰çŠ¶æ€: ${systemState.verificationState.consecutivePasses}/${systemState.verificationState.requiredPasses}è¿ç»­é€šè¿‡\néªŒè¯å¾—åˆ†: ${systemState.verificationState.verificationScore}/100\nç½®ä¿¡åº¦: ${systemState.verificationState.confidence}%\n\nå°†åŸºäºå®¡æŸ¥åçš„é”™è¯¯æŠ¥å‘Šè¿›è¡Œä¸‹ä¸€è½®æ”¹è¿›ã€‚`);
                        
                        // é‡ç½®ä¸»æ­¥éª¤çŠ¶æ€å‡†å¤‡ä¸‹ä¸€è½®
                        for (let i = 1; i <= 6; i++) {
                            updateMainStepStatus(i, '');
                        }
                    }

                    previousSolution = currentSolution;
                }

                // æ˜¾ç¤ºéªŒè¯æ‘˜è¦
                const summaryDiv = showVerificationSummary(systemState.verificationState);
                resultsContainer.appendChild(summaryDiv);

                // æ˜¾ç¤ºæœ€ç»ˆæ€»ç»“
                const finalSummary = document.createElement('div');
                finalSummary.style.cssText = `
                    background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
                    color: white;
                    padding: 30px;
                    border-radius: 12px;
                    margin-top: 30px;
                    text-align: center;
                    box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
                `;
                finalSummary.innerHTML = `
                    <h3>ğŸ”¬ ä¸¥æ ¼æ•°å­¦éªŒè¯å®Œæˆ v2.1ï¼</h3>
                    <div style="margin: 20px 0; font-size: 1.1rem;">
                        <div>ğŸ”„ æ€»éªŒè¯è½®æ•°: ${iterationCount}</div>
                        <div>âœ… è¿ç»­éªŒè¯é€šè¿‡: ${systemState.verificationState.consecutivePasses}æ¬¡</div>
                        <div>ğŸ¯ éªŒè¯å¾—åˆ†: ${systemState.verificationState.verificationScore}/100</div>
                        <div>ğŸ PythonéªŒè¯æ¬¡æ•°: ${systemState.verificationState.pythonValidations}</div>
                        <div>âŒ Pythonå¤±è´¥æ¬¡æ•°: ${systemState.verificationState.pythonFailures}</div>
                        <div>ğŸ“Š æœ€ç»ˆç½®ä¿¡åº¦: ${systemState.verificationState.confidence}%</div>
                        <div>ğŸ” å‘ç°é”™è¯¯æ€»æ•°: ${systemState.verificationState.totalErrors}</div>
                        <div>ğŸ’¾ ä¿å­˜æ–‡ä»¶æ•°: ${systemState.savedFiles.length}ä¸ª</div>
                        <div>ğŸ¤– AIæä¾›å•†: ${systemState.aiConfig.provider.toUpperCase()} (${systemState.aiConfig.model})</div>
                    </div>
                    <p style="margin-top: 15px; font-size: 0.95rem; opacity: 0.9;">
                        åŸºäºè®ºæ–‡é€»è¾‘çš„ä¸¥æ ¼æ•°å­¦éªŒè¯ç³»ç»Ÿ v2.1ï¼Œé›†æˆ7ä¸ªPythonéªŒè¯èŠ‚ç‚¹ï¼Œ<br>
                        é‡‡ç”¨ä¸¥æ ¼çš„æ‰£åˆ†åˆ¶è¯„åˆ†æœºåˆ¶ï¼Œç¡®ä¿æ•°å­¦æ¨ç†ä¸è®¡ç®—éªŒè¯çš„å¯é æ€§
                    </p>
                `;
                resultsContainer.appendChild(finalSummary);

                // å¦‚æœéªŒè¯é€šè¿‡ï¼Œæ·»åŠ å¿«é€Ÿæ“ä½œæŒ‰é’®
                if (systemState.verificationState.consecutivePasses >= systemState.verificationState.requiredPasses) {
                    addQuickActions(resultsContainer);
                    
                    // è‡ªåŠ¨ç”Ÿæˆè¾“å‡ºæ–‡ä»¶
                    if (document.getElementById('auto-save').checked) {
                        setTimeout(async () => {
                            await generateFinalOutputs();
                        }, 1500);
                    }
                }

            } catch (error) {
                console.error('ä¸¥æ ¼éªŒè¯æµç¨‹å¤±è´¥:', error);
                
                updateMainStepStatus(systemState.verificationState.currentStep + 1, 'failed');
                showVerificationResult(systemState.verificationState.currentStep + 1, 'éªŒè¯å¤±è´¥', `âŒ ä¸¥æ ¼éªŒè¯æµç¨‹å¤±è´¥: ${error.message}`, 'failed');
                showNotification(`éªŒè¯å¤±è´¥: ${error.message}`, 'error');
                
            } finally {
                systemState.verificationState.isRunning = false;
                solveButton.disabled = false;
                solveButton.textContent = 'ğŸš€ å¯åŠ¨ä¸¥æ ¼éªŒè¯æµç¨‹';
                document.getElementById('loading').classList.remove('show');
                
                // ä¿®å¤äº‹ä»¶ç»‘å®š
                fixSaveButtonEvents();
                
                // è‡ªåŠ¨ä¿å­˜
                autoSaveOnCompletion();
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆ
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ä¸¥æ ¼æ•°å­¦éªŒè¯ç³»ç»Ÿ v2.1 å·²å¯åŠ¨');
            
            updateModelOptions();
            document.getElementById('api-provider').addEventListener('change', updateModelOptions);
            
            const pythonReady = await initPython();
            
            if (pythonReady) {
                console.log('Pythonç¯å¢ƒåˆå§‹åŒ–æˆåŠŸ');
                showNotification('Pythonç¯å¢ƒåˆå§‹åŒ–å®Œæˆ', 'success');
            } else {
                console.error('Pythonç¯å¢ƒåˆå§‹åŒ–å¤±è´¥');
                showNotification('Pythonç¯å¢ƒåˆå§‹åŒ–å¤±è´¥ï¼ŒæŸäº›åŠŸèƒ½å¯èƒ½ä¸å¯ç”¨', 'error');
            }

            if (window.MathJax) {
                console.log('MathJaxå·²åŠ è½½ï¼Œæ•°å­¦å…¬å¼æ¸²æŸ“å°±ç»ª');
            }

            // è®¾ç½®é»˜è®¤é…ç½®
            document.getElementById('api-provider').value = 'deepseek';
            document.getElementById('max-iterations').value = '8';
            document.getElementById('consecutive-passes-config').value = '3';
            document.getElementById('verification-rigor').value = 'strict';
            
            updateStatusDisplay();
            updateSavedFilesCount();
        });
    </script>
</body>
</html>
					
